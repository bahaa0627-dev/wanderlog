下面这套你可以**一次定死**，开发照抄实现即可：R2 存图、iOS 直接访问、URL 不暴露 place_id、可长期扩到 1–10 万张图也不乱。

---

# 一次定死：R2 图片存储与 URL 方案（iOS 直链可用）

## 1) 对外访问方式（固定）

* 绑定一个图片域名（推荐）：`https://img.yourdomain.com`

  * 指向 Cloudflare（R2 public bucket 或 Worker 前置都可以）
* iOS 永远只用这个域名下的 URL（便于未来切换存储/加防盗链/加缩略图）

> 如果你暂时没有自定义域名，也可以先用 R2 的公开 URL，但仍按下面 key 规则走；后续换域名只需要批量替换前缀或用 Worker 兼容。

---

## 2) R2 Object Key 规范（不含 place_id）

### 永久规范：**UUID + 分层目录**

* `places/cover/v1/{p1}/{p2}/{uuid}.jpg`

其中：

* `{uuid}`：`uuidv4()`（随机，不可推断）
* `{p1}`：uuid 的前 2 位（例如 `a3`）
* `{p2}`：uuid 的第 3–4 位（例如 `f9`）
* `v1`：版本号（未来你换格式/策略可以升到 v2 不影响旧图）

✅ 示例：

* R2 key：`places/cover/v1/a3/f9/a3f9c2d9-5e0e-4a8d-9c2f-2bdb2c9f0a11.jpg`
* 对外 URL：`https://img.yourdomain.com/places/cover/v1/a3/f9/a3f9c2d9-5e0e-4a8d-9c2f-2bdb2c9f0a11.jpg`

优点：

* 不暴露 place_id
* 目录分层避免单目录文件过多
* 未来可版本迁移（v2/webp/多尺寸）

---

## 3) 存储格式（固定）

**先统一存 JPEG：**

* 文件后缀固定 `.jpg`
* 上传前如果下载到的不是 jpg，服务端转成 jpg（质量 82–88，宽高不裁切，最长边可限制 1600 以内防止超大）

> JPEG 在 iOS 上最稳；你后面要省流量再做 webp 另开 v2。

---

## 4) HTTP Headers（固定，iOS 友好）

上传到 R2 时设置：

* `Content-Type: image/jpeg`
* `Cache-Control: public, max-age=31536000, immutable`

这样 iOS 加载快、缓存稳定。

---

## 5) Supabase 字段落库（固定）

你的表里已经有 `cover_image`，建议固定这么存：

* `cover_image`：**对外 URL**（iOS 直接用）
* `custom_fields.r2_key`：R2 key（内部追溯）
* `custom_fields.image_source_url`：原始 Google imageUrl（可选）
* `custom_fields.image_migrated_at`：时间戳（可选）

**永远不要**在 R2 key 或 URL 里放 `placeId/google_place_id`。

---

## 6) 导入时图片处理流程（固定）

对每条 Apify record：

1. 取 `imageUrl`（没有就跳过图片上传）
2. 下载图片（超时 8–10s，失败重试 1 次）
3. 生成 `uuidv4`
4. 按规则拼 `r2_key`
5. 上传到 R2（写 headers）
6. 写库：

   * `cover_image = https://img.yourdomain.com/{r2_key}`
   * `custom_fields.r2_key = r2_key`
   * 可选：`custom_fields.image_source_url = imageUrl`

> 这样你后续做图片修复/重传也简单：查 `r2_key` 就知道对象在哪里。

---

## 7) 未来扩展（先写进规范但现在不用做）

* 你以后要多图：就用 `places/images/v1/.../{uuid}_{idx}.jpg`
* 你以后要缩略图：`places/cover_thumb/v1/.../{uuid}.jpg`（生成 512px）
* 要 webp：开 `v2` 并把后缀换成 `.webp`

都不影响现有 `cover_image`，因为 v1 URL 永久有效。

---

### 最终你要给开发的一句话

> “所有封面图都上传到 R2，key 固定为 `places/cover/v1/{uuid_prefix2}/{uuid_prefix2}/{uuid}.jpg`，对外 URL 用 `https://img.yourdomain.com/{key}`，`cover_image` 存这个 URL，禁止在 URL 或 key 中出现 google_place_id/placeId。”
