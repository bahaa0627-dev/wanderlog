# ä½¿ç”¨ Node.js 20 Alpine é•œåƒ
FROM node:20-alpine

RUN echo "ğŸ”¥ DOCKERFILE_FINGERPRINT=2025-12-26-xyz"


# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json ./
COPY prisma ./prisma/

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œå› ä¸ºéœ€è¦ prisma CLI å’Œ typescriptï¼‰
RUN npm install

# ä½¿ç”¨é¡¹ç›®å®‰è£…çš„ prisma ç‰ˆæœ¬ç”Ÿæˆ Client
RUN ./node_modules/.bin/prisma generate

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»º TypeScript
RUN npm run build

# éªŒè¯æ„å»ºäº§ç‰©å­˜åœ¨
RUN ls -la dist/ && echo "âœ… Build artifacts verified"

# åˆ é™¤ devDependencies å‡å°é•œåƒä½“ç§¯ï¼ˆä½†ä¿ç•™ @prisma/clientï¼‰
RUN npm prune --omit=dev

# æš´éœ²ç«¯å£
EXPOSE 3000

# è¯Šæ–­å¯åŠ¨å‘½ä»¤
CMD ["sh","-c","set -ex; echo 'PWD='$(pwd); ls -la; echo '--- dist ---'; ls -la dist || true; echo '--- head dist/index.js ---'; head -n 50 dist/index.js || true; echo '--- run node ---'; node dist/index.js"]

