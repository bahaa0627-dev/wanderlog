<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å…±åœ°ç‚¹ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header .version {
            font-size: 11px;
            opacity: 0.7;
            font-family: monospace;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .filters {
            padding: 24px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: white;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        .stats {
            padding: 16px 24px;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-info {
            font-size: 14px;
            color: #666;
        }

        .stats-info strong {
            color: #333;
            font-weight: 600;
        }

        .active-filters {
            padding: 12px 24px;
            background: #fff3cd;
            border-bottom: 1px solid #ffc107;
            display: none;
        }

        .active-filters.show {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: white;
            border: 1px solid #ffc107;
            border-radius: 16px;
            font-size: 13px;
            color: #856404;
        }

        .filter-tag button {
            background: none;
            border: none;
            color: #856404;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
        }

        .table-container {
            padding: 24px;
            position: relative;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100%;
        }
        
        .places-table-wrapper {
            position: relative;
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        #placesTable {
            width: 100%;
            min-width: 1800px;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
        }
        
        #placesTable th,
        #placesTable td {
            border: 1px solid #e0e0e0;
            border-left: none;
            border-top: none;
            padding: 10px;
            background: #fff;
            box-sizing: border-box;
        }
        
        #placesTable th:first-child,
        #placesTable td:first-child {
            border-left: none;
        }
        
        #placesTable thead tr:first-child th {
            border-top: none;
        }
        
        #placesTable th {
            white-space: nowrap;
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        #placesTable td {
            vertical-align: top;
        }
        
        /* å†»ç»“ç¬¬ä¸€åˆ—ï¼šç…§ç‰‡ */
        #placesTable th:first-child,
        #placesTable td:first-child {
            position: sticky;
            left: 0;
            z-index: 3;
            background: #fff;
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        }
        
        #placesTable th:first-child {
            z-index: 4;
            background: #f8f9fa;
        }
        
        /* å†»ç»“ç¬¬äºŒåˆ—ï¼šåœ°ç‚¹ä¿¡æ¯ */
        #placesTable th:nth-child(2),
        #placesTable td:nth-child(2) {
            position: sticky;
            left: 80px;
            z-index: 3;
            background: #fff;
            width: 180px;
            min-width: 180px;
            max-width: 180px;
            box-shadow: 4px 0 6px rgba(0,0,0,0.08);
        }
        
        #placesTable th:nth-child(2) {
            z-index: 4;
            background: #f8f9fa;
        }
        
        /* å†»ç»“æœ€åä¸€åˆ—ï¼šæ“ä½œ */
        #placesTable th:last-child,
        #placesTable td:last-child {
            position: sticky;
            right: 0;
            z-index: 3;
            background: #fff;
            width: 110px;
            min-width: 110px;
            max-width: 110px;
            box-shadow: -4px 0 6px rgba(0,0,0,0.08);
        }
        
        #placesTable th:last-child {
            z-index: 4;
            background: #f8f9fa;
        }
        
        /* é¼ æ ‡æ‚¬åœè¡Œé«˜äº® */
        #placesTable tbody tr:hover td {
            background: #f0f4ff;
        }
        
        #placesTable tbody tr:hover td:first-child,
        #placesTable tbody tr:hover td:nth-child(2),
        #placesTable tbody tr:hover td:last-child {
            background: #f0f4ff;
        }
        
        #placesTable td.wrap-cell {
            white-space: normal;
            word-break: break-word;
            max-width: 180px;
        }
        
        #placesTable td.nowrap-cell {
            white-space: nowrap;
        }
        
        .opening-hours-list {
            font-size: 11px;
            color: #666;
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .opening-hours-list li {
            margin-bottom: 2px;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-width: 150px;
        }
        
        .action-btns {
            display: flex;
            gap: 6px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f5f5f5;
            color: #666;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 16px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        tr:hover {
            background: #fafafa;
        }

        .place-name {
            font-weight: 600;
            color: #667eea;
        }

        .place-address {
            color: #999;
            font-size: 13px;
            margin-top: 4px;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-rating {
            background: #fff3cd;
            color: #856404;
        }

        .badge-category {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-location {
            background: #d4edda;
            color: #155724;
        }

        .photo {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            background: #f0f0f0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo:hover {
            transform: scale(1.05);
        }

        .photo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 24px;
        }

        .pagination {
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .pagination .current-page {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .rating-star {
            color: #ffc107;
            margin-right: 4px;
        }

        .nav-tabs {
            display: flex;
            gap: 12px;
            padding: 16px 24px 0 24px;
        }

        .tab-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-weight: 600;
            color: #444;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #667eea;
            color: #fff;
            border-color: #667eea;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-card {
            margin: 16px 24px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }

        .form-group input, .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .token-note {
            font-size: 12px;
            color: #888;
        }

        .login-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            align-items: end;
            margin-top: 8px;
        }

        .login-status {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
        }

        .login-status.success {
            color: #2e7d32;
            font-weight: 600;
        }

        /* é¡¶éƒ¨ç™»å½•å…¥å£ */
        .top-actions {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            gap: 10px;
        }

        .collections-actions {
            display: flex;
            justify-content: flex-end;
            padding: 0 24px 12px 24px;
        }

        /* å¼¹çª— */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 360px;
            max-width: 90vw;
            box-shadow: 0 12px 40px rgba(0,0,0,0.16);
        }

        .modal h3 {
            margin-bottom: 12px;
            font-size: 18px;
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .upload-hint {
            font-size: 12px;
            color: #666;
        }

        .upload-preview {
            margin-top: 8px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .upload-preview img {
            width: 120px;
            height: 160px; /* 3:4 portrait preview */
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: #f5f5f5;
        }

        .upload-preview .info {
            font-size: 12px;
            color: #666;
        }

        .dropdown {
            position: relative;
        }

        .dropdown {
            position: relative;
        }
        
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }

        .dropdown-item {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #f5f5f5;
        }

        .chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .chip {
            background: #eef2ff;
            color: #3743a6;
            padding: 8px 10px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #dfe3ff;
        }

        .chip button {
            border: none;
            background: transparent;
            cursor: pointer;
            color: #999;
            font-size: 16px;
            line-height: 1;
        }

        .chip button:hover {
            color: #dc3545;
        }

        .chip-remove {
            margin-left: 4px;
            padding: 0 4px;
        }

        .draggable-collection {
            cursor: move;
            user-select: none;
        }

        .draggable-collection:hover {
            background: #dfe3ff;
        }

        .draggable-collection.dragging {
            opacity: 0.5;
        }

        .draggable-recommendation {
            cursor: move;
            user-select: none;
            transition: background-color 0.2s;
        }

        .draggable-recommendation:hover {
            background: #f5f5f5;
        }

        .draggable-recommendation.dragging {
            opacity: 0.5;
            background: #e3f2fd;
        }

        .section-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .list-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .tag-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .tag-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .tag-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .accordion {
            margin-top: 8px;
        }

        .accordion details summary {
            cursor: pointer;
            font-weight: 600;
            color: #444;
        }

        /* Toast æç¤ºæ ·å¼ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: toastIn 0.3s ease-out;
            max-width: 300px;
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        .toast.fadeOut {
            animation: toastOut 0.3s ease-in forwards;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <!-- Toast å®¹å™¨ -->
    <div id="toastContainer" class="toast-container"></div>
    
    <div class="container">
        <div class="header">
            <div class="top-actions">
                <button id="loginButton" class="btn btn-secondary">ç®¡ç†å‘˜ç™»å½•</button>
            </div>
            <h1>ğŸ—ºï¸ å…¬å…±åœ°ç‚¹ç®¡ç†åå° <span class="version">v2.3.0</span></h1>
            <p>ç­›é€‰ã€æœç´¢å’Œæµè§ˆæ•°æ®åº“ä¸­çš„æ‰€æœ‰åœ°ç‚¹</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" id="tab-places" onclick="showSection('places')">åœ°ç‚¹åº“</button>
            <button class="tab-btn" id="tab-collections" onclick="showSection('collections')">åˆé›†åº“</button>
            <button class="tab-btn" id="tab-recommendations" onclick="showSection('recommendations')">åˆé›†æ¨è</button>
        </div>

        <div id="placesSection" class="section active">
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="search">ğŸ” æœç´¢</label>
                    <input type="text" id="search" placeholder="è¾“å…¥åœ°ç‚¹åç§°æˆ–åœ°å€...">
                </div>
                <div class="filter-group">
                    <label for="country">ğŸŒ å›½å®¶ <small style="color: #999;">(ä¼˜å…ˆ)</small></label>
                    <select id="country">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="city">ğŸ™ï¸ åŸå¸‚ <small style="color: #999;">(è”åŠ¨)</small></label>
                    <select id="city">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="category">ğŸ·ï¸ åˆ†ç±» <small style="color: #999;">(è”åŠ¨)</small></label>
                    <select id="category" onchange="updateFilterOptions()">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="minRating">â­ æœ€ä½è¯„åˆ†</label>
                    <input type="number" id="minRating" min="0" max="5" step="0.1" placeholder="0.0">
                </div>
                <div class="filter-group">
                    <label for="maxRating">â­ æœ€é«˜è¯„åˆ†</label>
                    <input type="number" id="maxRating" min="0" max="5" step="0.1" placeholder="5.0">
                </div>
                <div class="filter-group">
                    <label for="sortBy">ğŸ“Š æ’åºå­—æ®µ</label>
                    <select id="sortBy">
                        <option value="">é»˜è®¤</option>
                        <option value="rating">è¯„åˆ†</option>
                        <option value="ratingCount">è¯„åˆ†äººæ•°</option>
                        <option value="createdAt">åˆ›å»ºæ—¶é—´</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortOrder">â†•ï¸ æ’åºæ–¹å‘</label>
                    <select id="sortOrder">
                        <option value="desc">é™åº (é«˜â†’ä½)</option>
                        <option value="asc">å‡åº (ä½â†’é«˜)</option>
                    </select>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="tagTypeFilter">ğŸ·ï¸ æ ‡ç­¾ç±»å‹</label>
                    <select id="tagTypeFilter" onchange="updateTagsByType()">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="tagFilter">ğŸ·ï¸ æ ‡ç­¾ <small style="color: #999;">(è”åŠ¨)</small></label>
                    <select id="tagFilter">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sourceFilter">ğŸ“¦ æ¥æº</label>
                    <select id="sourceFilter">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="hasCoverImage">ğŸ–¼ï¸ å°é¢å›¾</label>
                    <select id="hasCoverImage">
                        <option value="">å…¨éƒ¨</option>
                        <option value="true">æœ‰å°é¢å›¾</option>
                        <option value="false">æ— å°é¢å›¾</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                <button class="btn btn-primary" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                <button class="btn btn-secondary" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
                </div>
                <button class="btn btn-primary" onclick="openAddPlaceModal()">+ æ–°å¢åœ°ç‚¹</button>
            </div>
        </div>

        <div class="active-filters" id="activeFilters"></div>

        <div class="stats" id="stats">
            <div class="stats-info">åŠ è½½ä¸­...</div>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">åŠ è½½ä¸­</div>
            <div id="empty" class="empty" style="display: none;">æš‚æ— æ•°æ®</div>
            <div class="places-table-wrapper">
            <table id="placesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ç…§ç‰‡</th>
                        <th>åœ°ç‚¹ä¿¡æ¯</th>
                        <th>åŸå¸‚</th>
                        <th>å›½å®¶</th>
                        <th>åæ ‡</th>
                        <th>è¯„åˆ†</th>
                        <th>åˆ†ç±»</th>
                        <th>æè¿°/æ‘˜è¦</th>
                        <th>è¥ä¸šæ—¶é—´</th>
                        <th>ä»·æ ¼åŒºé—´</th>
                        <th>è”ç³»æ–¹å¼</th>
                        <th>æ ‡ç­¾</th>
                        <th>æ¥æº</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="placesBody"></tbody>
            </table>
            </div><!-- places-table-wrapper -->
        </div>

        <div class="pagination" id="pagination" style="display: none;"></div>
        </div> <!-- placesSection -->

        <div id="collectionsSection" class="section">
            <div class="collections-actions">
                <button class="btn btn-secondary" type="button" onclick="refreshCollections()" style="margin-right: 8px;">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-primary" type="button" onclick="startCreateCollection()">åˆ›å»ºåˆé›†</button>
            </div>
            <div id="collectionFormContainer" class="form-card" style="display:none;">
                <div id="collectionFormHeader" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="cancelEdit()">â† è¿”å›åˆ—è¡¨</button>
                    <span id="editModeTitle" style="margin-left: 16px; font-weight: 600; color: #666;"></span>
                </div>
                        <input id="adminToken" type="hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>åˆé›†åç§° *</label>
                        <input id="colName" type="text" placeholder="å¦‚ï¼šå“¥æœ¬å“ˆæ ¹å¿…å»å’–å•¡é¦†" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <input id="colDesc" type="text" placeholder="ä¸€å¥è¯æè¿°" autocomplete="off">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å°é¢å›¾ä¸Šä¼  *ï¼ˆç«–å‘ 4:3ï¼Œâ‰¤5MBï¼‰</label>
                        <input id="colCoverFile" type="file" accept="image/*" onchange="handleCoverFile(this.files)">
                        <div class="upload-hint">æ”¯æŒæœ¬åœ°å›¾ç‰‡ï¼Œè‡ªåŠ¨è½¬æ¢ä¸º DataURLã€‚å°ºå¯¸â‰¤5MBï¼Œå®½é«˜çº¦ 3:4ï¼ˆç«–å‘ï¼‰ã€‚</div>
                        <div class="upload-preview" id="coverPreview" style="display:none;">
                            <img id="coverPreviewImg" alt="å°é¢é¢„è§ˆ">
                            <div class="info" id="coverPreviewInfo"></div>
                        </div>
                        <input id="colCover" type="hidden">
                    </div>
                </div>
                <div class="form-card" style="margin:0; margin-top:8px;">
                    <div class="section-title">åœ°ç‚¹é€‰æ‹©ï¼ˆå¿…å¡«ï¼Œè‡³å°‘ 1 ä¸ªï¼Œå¯æ·»åŠ å¤šä¸ªï¼‰</div>
                    <div class="form-row">
                        <div class="form-group dropdown">
                            <label>åœ°ç‚¹åç§°ï¼ˆè¾“å…¥å­—æ¯è¿›è¡Œæ¨¡ç³ŠåŒ¹é…æœç´¢ï¼‰</label>
                            <input id="spotSearchInput" type="text" placeholder="è¾“å…¥åœ°ç‚¹åç§°ã€åœ°å€æˆ–åŸå¸‚è¿›è¡Œæœç´¢..." oninput="handleSpotSearch(this.value)" autocomplete="off">
                            <div id="spotSearchDropdown" class="dropdown-list" style="display:none;"></div>
                        </div>
                        <div class="form-group">
                            <label>çº¬åº¦</label>
                            <input id="spotLat" type="number" step="any" placeholder="å¦‚ 55.6761" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>ç»åº¦</label>
                            <input id="spotLng" type="number" step="any" placeholder="å¦‚ 12.5683" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary" type="button" onclick="searchByLatLng()">æŒ‰ç»çº¬åº¦æŸ¥æ‰¾</button>
                        </div>
                    </div>
                    <div id="selectedSpots" class="chip-list"></div>
                </div>

                <div class="form-card" style="margin:0; margin-top:8px;">
                    <div class="section-title">äººç‰©ï¼ˆå¯é€‰ï¼‰</div>
                    <div class="form-actions" style="margin-top:0;">
                        <button class="btn btn-secondary" type="button" onclick="addPerson()">+ æ·»åŠ äººç‰©</button>
                    </div>
                    <div id="peopleList"></div>
                </div>

                <div class="form-card" style="margin:0; margin-top:8px;">
                    <div class="section-title">ä½œå“ï¼ˆå¯é€‰ï¼‰</div>
                    <div class="form-actions" style="margin-top:0;">
                        <button class="btn btn-secondary" type="button" onclick="addWork()">+ æ·»åŠ ä½œå“</button>
                    </div>
                    <div id="worksList"></div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary" id="saveCollectionBtn" onclick="createCollection()">åˆ›å»ºåˆé›†</button>
                    <button class="btn btn-secondary" onclick="clearCollectionForm()">æ¸…ç©º</button>
                </div>
            </div>

            <div id="collectionsListContainer" class="table-container">
                <div id="collectionsLoading" class="loading">åŠ è½½ä¸­</div>
                <div id="collectionsEmpty" class="empty" style="display:none;">æš‚æ— åˆé›†</div>
                <table id="collectionsTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>å°é¢</th>
                            <th>åç§°</th>
                            <th>åœ°ç‚¹æ•°é‡</th>
                            <th>çŠ¶æ€</th>
                            <th>æè¿°</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="collectionsBody"></tbody>
                </table>
            </div>
        </div> <!-- collectionsSection -->

        <div id="recommendationsSection" class="section">
            <div class="collections-actions">
                <button class="btn btn-secondary" type="button" onclick="refreshRecommendations()" style="margin-right: 8px;">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-primary" type="button" onclick="startCreateRecommendation()">åˆ›å»ºåˆé›†æ¨è</button>
            </div>
            <div id="recommendationFormContainer" class="form-card" style="display:none;">
                <div id="recommendationFormHeader" style="display: none; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="cancelEditRecommendation()">â† è¿”å›åˆ—è¡¨</button>
                    <span id="editRecommendationModeTitle" style="margin-left: 16px; font-weight: 600; color: #666;"></span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ¨èåç§° *</label>
                        <input id="recommendationName" type="text" placeholder="å¦‚ï¼šå·´é»å¿…æ¸¸æ¨è" autocomplete="off">
                    </div>
                </div>
                <div class="form-card" style="margin:0; margin-top:8px;">
                    <div class="section-title">åˆé›†é€‰æ‹©ï¼ˆå¿…å¡«ï¼Œè‡³å°‘ 1 ä¸ªï¼Œå¯æ·»åŠ å¤šä¸ªï¼Œæ”¯æŒæ‹–æ‹½æ’åºï¼‰</div>
                    <div class="form-row">
                        <div class="form-group dropdown" style="flex: 1;">
                            <label>åˆé›†åç§°ï¼ˆè¾“å…¥è¿›è¡Œæ¨¡ç³ŠåŒ¹é…æœç´¢ï¼‰</label>
                            <input id="collectionSearchInput" type="text" placeholder="è¾“å…¥åˆé›†åç§°è¿›è¡Œæœç´¢..." oninput="handleCollectionSearch(this.value)" autocomplete="off">
                            <div id="collectionSearchDropdown" class="dropdown-list" style="display:none;"></div>
                        </div>
                    </div>
                    <div id="selectedCollections" class="chip-list" style="min-height: 100px;"></div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" id="saveRecommendationBtn" type="button" onclick="saveRecommendation()">ä¿å­˜</button>
                    <button class="btn btn-secondary" type="button" onclick="cancelEditRecommendation()">å–æ¶ˆ</button>
                </div>
            </div>

            <div id="recommendationsListContainer" class="table-container">
                <div id="recommendationsLoading" class="loading">åŠ è½½ä¸­</div>
                <div id="recommendationsEmpty" class="empty" style="display:none;">æš‚æ— åˆé›†æ¨è</div>
                <table id="recommendationsTable" style="display:none;">
                    <thead>
                        <tr>
                            <th style="width: 40px;">æ’åº</th>
                            <th>åç§°</th>
                            <th>åˆé›†æ•°é‡</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="recommendationsBody"></tbody>
                </table>
            </div>
        </div> <!-- recommendationsSection -->
    </div>

    <!-- ç®¡ç†å‘˜ç™»å½•å¼¹çª— -->
    <div class="modal-backdrop" id="loginModal">
        <div class="modal">
            <h3>ç®¡ç†å‘˜ç™»å½•</h3>
            <form autocomplete="off" onsubmit="event.preventDefault(); adminLogin(true);">
            <div class="form-group">
                <label>ç®¡ç†å‘˜é‚®ç®±</label>
                <input id="adminEmail" type="email" placeholder="admin@example.com" value="admin@vago.to" autocomplete="off">
            </div>
            <div class="form-group">
                <label>ç®¡ç†å‘˜å¯†ç </label>
                <input id="adminPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value="dxr920627" autocomplete="new-password">
            </div>
            <div class="login-status" id="loginStatusModal">æœªç™»å½•</div>
            <div class="modal-actions">
                <button class="btn btn-primary" type="submit">ç™»å½•</button>
                <button class="btn btn-secondary" type="button" onclick="closeLoginModal()">å–æ¶ˆ</button>
            </div>
            </form>
        </div>
    </div>
    
    <!-- åœ°ç‚¹ç¼–è¾‘/æ–°å¢å¼¹çª— -->
    <div class="modal-backdrop" id="placeModal" style="display:none;">
        <div class="modal" style="width:700px;max-width:95vw;max-height:90vh;overflow-y:auto;">
            <h3 id="placeModalTitle">ç¼–è¾‘åœ°ç‚¹</h3>
            <form autocomplete="off" onsubmit="event.preventDefault(); savePlaceData();">
            <input type="hidden" id="editPlaceId">
            
            <div class="form-row">
                <div class="form-group">
                    <label>åœ°ç‚¹åç§° *</label>
                    <input id="placeName" type="text" placeholder="å¦‚ï¼šä¸œäº¬å¡”" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="placeCategory">
                        <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                        <option value="landmark">Landmark (åœ°æ ‡)</option>
                        <option value="museum">Museum (åšç‰©é¦†)</option>
                        <option value="art_gallery">Gallery (ç¾æœ¯é¦†)</option>
                        <option value="shopping_mall">Shopping (å•†åœº)</option>
                        <option value="cafe">Cafe (å’–å•¡åº—)</option>
                        <option value="bakery">Bakery (é¢åŒ…åº—)</option>
                        <option value="restaurant">Restaurant (é¤é¦†)</option>
                        <option value="bar">Bar (é…’å§)</option>
                        <option value="hotel">Hotel (é…’åº—)</option>
                        <option value="church">Church (æ•™å ‚)</option>
                        <option value="library">Library (å›¾ä¹¦é¦†)</option>
                        <option value="bookstore">Bookstore (ä¹¦åº—)</option>
                        <option value="cemetery">Cemetery (å¢“å›­)</option>
                        <option value="park">Park (å…¬å›­)</option>
                        <option value="castle">Castle (åŸå ¡)</option>
                        <option value="market">Market (å¸‚é›†)</option>
                        <option value="shop">Shop (å•†åº—)</option>
                        <option value="yarn_store">Yarn (æ¯›çº¿åº—)</option>
                        <option value="thrift_store">Thrift (äºŒæ‰‹åº—)</option>
                        <option value="university">University (å¤§å­¦)</option>
                        <option value="temple">Temple (å¯ºåº™)</option>
                        <option value="zoo">Zoo (åŠ¨ç‰©å›­)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group dropdown">
                    <label>å›½å®¶</label>
                    <div style="position: relative;">
                        <input id="placeCountry" type="text" placeholder="è¾“å…¥æˆ–é€‰æ‹©å›½å®¶..." autocomplete="off" onclick="showCountryDropdown()" oninput="filterCountryDropdown(this.value)" onchange="updatePlaceCityOptions()" style="padding-right: 30px;">
                        <span onclick="toggleCountryDropdown()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666;">â–¼</span>
                        <div id="placeCountryDropdown" class="dropdown-list" style="display:none;"></div>
                    </div>
                </div>
                <div class="form-group dropdown">
                    <label>åŸå¸‚</label>
                    <div style="position: relative;">
                        <input id="placeCity" type="text" placeholder="è¾“å…¥æˆ–é€‰æ‹©åŸå¸‚..." autocomplete="off" onclick="showCityDropdown()" oninput="filterCityDropdown(this.value)" style="padding-right: 30px;">
                        <span onclick="toggleCityDropdown()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666;">â–¼</span>
                        <div id="placeCityDropdown" class="dropdown-list" style="display:none;"></div>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>çº¬åº¦ *</label>
                    <input id="placeLat" type="number" step="any" placeholder="å¦‚ï¼š35.6586" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>ç»åº¦ *</label>
                    <input id="placeLng" type="number" step="any" placeholder="å¦‚ï¼š139.7454" autocomplete="off">
                </div>
            </div>
            
            <div class="form-group">
                <label>åœ°å€</label>
                <input id="placeAddress" type="text" placeholder="è¯¦ç»†åœ°å€" style="width:100%;" autocomplete="off">
            </div>
            
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="placeDescription" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="åœ°ç‚¹æè¿°..." autocomplete="off"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>è¯„åˆ† (0-5)</label>
                    <input id="placeRating" type="number" step="0.1" min="0" max="5" placeholder="4.5" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>è¯„åˆ†æ•°é‡</label>
                    <input id="placeRatingCount" type="number" placeholder="1000" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>ä»·æ ¼ç­‰çº§ (0-4)</label>
                    <input id="placePriceLevel" type="number" min="0" max="4" placeholder="2" autocomplete="off">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>ç½‘ç«™</label>
                    <input id="placeWebsite" type="url" placeholder="https://..." autocomplete="off">
                </div>
                <div class="form-group">
                    <label>ç”µè¯</label>
                    <input id="placePhone" type="text" placeholder="+81-3-1234-5678" autocomplete="off">
                </div>
            </div>
            
            <div class="form-group">
                <label>è¥ä¸šæ—¶é—´ï¼ˆæ¯è¡Œä¸€å¤©ï¼Œå¦‚ï¼šMonday: 9:00 AM â€“ 5:00 PMï¼‰</label>
                <textarea id="placeOpeningHours" rows="4" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" placeholder="Monday: 9:00 AM â€“ 5:00 PM&#10;Tuesday: 9:00 AM â€“ 5:00 PM&#10;..." autocomplete="off"></textarea>
            </div>
            
            <div class="form-card" style="margin:8px 0;">
                <div class="section-title">æ ‡ç­¾ç®¡ç†</div>
                
                <div class="form-group">
                    <label>ç»“æ„åŒ–æ ‡ç­¾ (tags) <small style="color:#999;">æŒ‰å›è½¦æ·»åŠ ï¼Œè‡ªåŠ¨å½’ç±»</small></label>
                    <div class="tag-input-container" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;min-height:42px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:text;" onclick="document.getElementById('tagInput').focus()">
                        <div id="placeTagsChips" style="display:contents;"></div>
                        <input type="text" id="tagInput" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦..." style="border:none;outline:none;flex:1;min-width:120px;padding:4px;" onkeydown="handleTagInputKeydown(event)">
                    </div>
                    <input type="hidden" id="placeTagsJson">
                </div>
                
                <div class="form-group">
                    <label>AI å±•ç¤ºæ ‡ç­¾ (aiTags) <small style="color:#999;">æŒ‰å›è½¦æ·»åŠ </small></label>
                    <div class="tag-input-container" style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;min-height:42px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:text;" onclick="document.getElementById('aiTagInput').focus()">
                        <div id="placeAiTagsChips" style="display:contents;"></div>
                        <input type="text" id="aiTagInput" placeholder="è¾“å…¥ AI æ ‡ç­¾åæŒ‰å›è½¦..." style="border:none;outline:none;flex:1;min-width:120px;padding:4px;" onkeydown="handleAiTagInputKeydown(event)">
                    </div>
                    <input type="hidden" id="placeAiTagsJson">
                </div>
            </div>
            
            <div class="form-card" style="margin:8px 0;">
                <div class="section-title">å›¾ç‰‡ç®¡ç†</div>
                <div class="form-group">
                    <label>å°é¢å›¾ URL</label>
                    <input id="placeCoverImage" type="text" placeholder="https://..." style="width:100%;" autocomplete="off">
                    <div id="coverImagePreview" style="margin-top:8px;"></div>
                </div>
                <div class="form-group">
                    <label>ä¸Šä¼ æ–°å›¾ç‰‡</label>
                    <input id="placeImageUpload" type="file" accept="image/*" onchange="handlePlaceImageUpload(this.files)">
                    <div class="upload-hint">æ”¯æŒæœ¬åœ°å›¾ç‰‡ä¸Šä¼ ï¼Œè‡ªåŠ¨è½¬æ¢ä¸º DataURL</div>
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡åˆ—è¡¨ï¼ˆç‚¹å‡»è®¾ä¸ºå°é¢ï¼‰</label>
                    <div id="placeImagesList" class="chip-list" style="margin-top:8px;"></div>
                </div>
                
                <div class="section-title" style="margin-top:16px;">å‰§ç…§ï¼ˆå¯é€‰ï¼‰</div>
                <div class="form-group">
                    <label>ä¸Šä¼ å‰§ç…§</label>
                    <input id="placeStillUpload" type="file" accept="image/*" onchange="handlePlaceStillUpload(this.files)">
                    <div class="upload-hint">ä¸è¯¥åœ°ç‚¹ç›¸å…³çš„å½±è§†å‰§ç…§ï¼Œéå¿…å¡«</div>
                </div>
                <div class="form-group">
                    <label>å‰§ç…§åˆ—è¡¨</label>
                    <div id="placeStillsList" class="chip-list" style="margin-top:8px;"></div>
                </div>
            </div>
            
            <div class="modal-actions" style="margin-top:16px;">
                <button class="btn btn-primary" type="submit">ä¿å­˜</button>
                <button class="btn btn-secondary" type="button" onclick="closePlaceModal()">å–æ¶ˆ</button>
            </div>
            </form>
        </div>
    </div>

    <script>
        // æ ¹æ®å½“å‰åŸŸåè‡ªåŠ¨é€‰æ‹© API åœ°å€
        // æœ¬åœ°å¼€å‘ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„
        // æµ‹è¯•ç¯å¢ƒï¼šapi-test.vago.to
        // ç”Ÿäº§ç¯å¢ƒï¼šapi.vago.to
        const getApiHost = () => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return ''; // æœ¬åœ°å¼€å‘ä½¿ç”¨ç›¸å¯¹è·¯å¾„
            }
            if (hostname.includes('test') || hostname.includes('pages.dev')) {
                return 'https://api-test.vago.to';
            }
            return 'https://api.vago.to';
        };
        const API_HOST = getApiHost();
        console.log('API_HOST:', API_HOST, 'hostname:', window.location.hostname);
        const API_BASE = `${API_HOST}/api/public-places`;
        const API_BASE_WITH_INTERNAL_TAGS = `${API_HOST}/api/public-places?includeInternalTags=true`;
        const SPOT_API_BASE = `${API_HOST}/api/spots`;
        const COLLECTION_API_BASE = `${API_HOST}/api/collections`;
        const RECOMMENDATION_API_BASE = `${API_HOST}/api/collection-recommendations`;
        const FETCH_TIMEOUT = 30000; // 30s è¶…æ—¶
        let currentPage = 1;
        let totalPages = 1;
        let filters = {};
        let allPlaces = []; // ç¼“å­˜æ‰€æœ‰åœ°ç‚¹æ•°æ®
        let collections = [];
        let recommendations = [];
        let selectedSpots = [];
        let selectedCollections = []; // ç”¨äºç¼–è¾‘æ¨èæ—¶å­˜å‚¨é€‰ä¸­çš„åˆé›†
        let spotSearchTimer = null;
        let collectionSearchTimer = null;
        let editingCollectionId = null;
        let editingRecommendationId = null;
        let peopleListData = [];
        let worksListData = [];
        
        // Toast æç¤ºå‡½æ•°
        function showToast(message, type = 'info', duration = 2500) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('fadeOut');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // ç”¨äºè·Ÿè¸ªåŸå§‹æ•°æ®ï¼Œæ£€æµ‹æ˜¯å¦æœ‰ä¿®æ”¹
        let originalCollectionData = null;
        let originalRecommendationData = null;

        // --- ç®¡ç†å‘˜ç™»å½• ---
        function setLoginStatus(text, success = false) {
            const el = document.getElementById('loginStatus');
            if (!el) return;
            el.textContent = text;
            el.classList.toggle('success', success);
        }

        let adminEmail = '';

        function updateTopActions() {
            const btn = document.getElementById('loginButton');
            if (!btn) return;
            const token = getStoredToken();
            const email = adminEmail || localStorage.getItem('adminEmail');
            if (token) {
                btn.textContent = email || 'å·²ç™»å½•';
                btn.onclick = handleLogoutConfirm;
            } else {
                btn.textContent = 'ç®¡ç†å‘˜ç™»å½•';
                btn.onclick = openLoginModal;
            }
        }

        function setAdminToken(token) {
            const input = document.getElementById('adminToken');
            if (input) input.value = token;
            if (token) {
                localStorage.setItem('adminToken', token);
                setLoginStatus('å·²ç™»å½•ï¼ˆtoken å·²ä¿å­˜ï¼‰', true);
                const modalStatus = document.getElementById('loginStatusModal');
                if (modalStatus) modalStatus.textContent = 'å·²ç™»å½•ï¼ˆtoken å·²ä¿å­˜ï¼‰';
            } else {
                localStorage.removeItem('adminToken');
                setLoginStatus('æœªç™»å½•', false);
                const modalStatus = document.getElementById('loginStatusModal');
                if (modalStatus) modalStatus.textContent = 'æœªç™»å½•';
            }
            updateTopActions();
        }

        function loadStoredToken() {
            const saved = localStorage.getItem('adminToken');
            const savedEmail = localStorage.getItem('adminEmail');
            if (savedEmail) adminEmail = savedEmail;
            if (saved) {
                setAdminToken(saved);
            } else {
                setLoginStatus('æœªç™»å½•');
                updateTopActions();
            }
        }

        async function adminLogin(closeOnSuccess = false) {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            if (!email || !password) {
                alert('è¯·è¾“å…¥ç®¡ç†å‘˜é‚®ç®±å’Œå¯†ç ');
                return;
            }
            try {
                const res = await fetch(`${API_HOST}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password }),
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data?.message || 'ç™»å½•å¤±è´¥');
                }
                if (!data?.token) {
                    throw new Error('æœªè·å–åˆ° token');
                }
                adminEmail = data?.user?.email || email;
                localStorage.setItem('adminEmail', adminEmail);
                setAdminToken(data.token);
                updateTopActions();
                alert('ç®¡ç†å‘˜ç™»å½•æˆåŠŸ');
                if (closeOnSuccess) closeLoginModal();
            } catch (err) {
                console.error('ç®¡ç†å‘˜ç™»å½•å¤±è´¥:', err);
                alert(`ç™»å½•å¤±è´¥ï¼š${err.message || err}`);
            }
        }

        function clearAdminToken() {
            setAdminToken('');
            const emailInput = document.getElementById('adminEmail');
            const pwdInput = document.getElementById('adminPassword');
            if (emailInput) emailInput.value = '';
            if (pwdInput) pwdInput.value = '';
            adminEmail = '';
            localStorage.removeItem('adminEmail');
            updateTopActions();
        }

        function openLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) modal.style.display = 'flex';
            // åŒæ­¥çŠ¶æ€æ–‡æœ¬
            const status = localStorage.getItem('adminToken') ? 'å·²ç™»å½•ï¼ˆtoken å·²ä¿å­˜ï¼‰' : 'æœªç™»å½•';
            const statusEl = document.getElementById('loginStatusModal');
            if (statusEl) statusEl.textContent = status;
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) modal.style.display = 'none';
        }

        function getStoredToken() {
            return localStorage.getItem('adminToken') || '';
        }

        function getTokenOrAlert() {
            const token = getStoredToken();
            if (!token) {
                alert('è¯·å…ˆç‚¹å‡»å³ä¸Šè§’â€œç®¡ç†å‘˜ç™»å½•â€è¾“å…¥é‚®ç®±å’Œå¯†ç ');
                openLoginModal();
                throw new Error('not_logged_in');
            }
            return token;
        }

        function handleLogoutConfirm() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç®¡ç†å‘˜ç™»å½•å—ï¼Ÿ')) {
                clearAdminToken();
                alert('å·²é€€å‡ºç™»å½•');
            }
        }

        function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), timeout))
            ]);
        }

        // åˆå§‹åŒ–
        async function init() {
            loadStoredToken();

            // å¹¶è¡ŒåŠ è½½ç­›é€‰é€‰é¡¹ï¼Œä¸é˜»å¡åœ°ç‚¹åˆ—è¡¨æ˜¾ç¤º
            loadFilterOptions().catch(err => {
                console.error('åŠ è½½ç­›é€‰å™¨æ•°æ®å¤±è´¥ï¼Œä½†ä¸å½±å“åœ°ç‚¹åˆ—è¡¨æ˜¾ç¤º:', err);
            });
            
            // ç«‹å³åŠ è½½åœ°ç‚¹åˆ—è¡¨ï¼Œä¸ç­‰å¾… loadFilterOptions
            await loadPlaces();
            
            // è®¾ç½®ç­›é€‰å™¨ç›‘å¬
            setupFilterListeners();
            
            // åŠ è½½åˆé›†ï¼ˆå¯é€‰ï¼Œä¸é˜»å¡ï¼‰
            loadCollections().catch(err => {
                console.error('åŠ è½½åˆé›†å¤±è´¥:', err);
            });
        }

        // åˆ‡æ¢é¡µç­¾
        async function showSection(section) {
            document.getElementById('placesSection').classList.remove('active');
            document.getElementById('collectionsSection').classList.remove('active');
            document.getElementById('recommendationsSection').classList.remove('active');
            document.getElementById('tab-places').classList.remove('active');
            document.getElementById('tab-collections').classList.remove('active');
            document.getElementById('tab-recommendations').classList.remove('active');

            if (section === 'collections') {
                document.getElementById('collectionsSection').classList.add('active');
                document.getElementById('tab-collections').classList.add('active');
                // åªåœ¨æ•°æ®ä¸ºç©ºæ—¶åŠ è½½ï¼Œé¿å…é‡å¤è¯·æ±‚
                if (collections.length === 0) {
                    await loadCollections();
                }
                // å¦‚æœä¸åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œæ˜¾ç¤ºåˆ—è¡¨
                if (!editingCollectionId) {
                    showCollectionsList();
                }
            } else if (section === 'recommendations') {
                document.getElementById('recommendationsSection').classList.add('active');
                document.getElementById('tab-recommendations').classList.add('active');
                if (recommendations.length === 0) {
                    await loadRecommendations();
                }
                // å¦‚æœä¸åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œæ˜¾ç¤ºåˆ—è¡¨
                if (!editingRecommendationId) {
                    showRecommendationsList();
                }
            } else {
                document.getElementById('placesSection').classList.add('active');
                document.getElementById('tab-places').classList.add('active');
            }
        }

        // å¼ºåˆ¶åˆ·æ–°åˆé›†æ•°æ®ï¼ˆç”¨äºåˆ›å»º/ç¼–è¾‘åï¼‰
        async function refreshCollections() {
            collections = [];
            await loadCollections();
        }

        // å¼ºåˆ¶åˆ·æ–°æ¨èæ•°æ®
        async function refreshRecommendations() {
            recommendations = [];
            await loadRecommendations();
        }

        // åŠ è½½æ‰€æœ‰åœ°ç‚¹æ•°æ®ï¼ˆç”¨äºç­›é€‰å™¨è”åŠ¨ï¼‰
        // æ”¹ç”¨ filter-options APIï¼Œåªè·å–ç­›é€‰é€‰é¡¹è€Œä¸æ˜¯æ‰€æœ‰æ•°æ®
        let filterOptions = { countries: [], citiesByCountry: {}, categories: [], tags: [], tagsByType: [], tagsByCountry: {} };
        
        async function loadFilterOptions() {
            console.log('ğŸš€ ç®¡ç†åå°ç‰ˆæœ¬: v2.3.0 - ä¿®å¤æ ‡ç­¾ç±»å‹æ£€æµ‹é€»è¾‘');
            try {
                const response = await fetchWithTimeout(`${API_BASE}/filter-options`, {}, 30000);
                const result = await response.json();
                if (result.success && result.data) {
                    filterOptions = result.data;
                    updateFilterOptionsUI();
                }
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°ç­›é€‰é€‰é¡¹ UI
        function updateFilterOptionsUI() {
            const countrySelect = document.getElementById('country');
            const citySelect = document.getElementById('city');
            const categorySelect = document.getElementById('category');
            const tagTypeSelect = document.getElementById('tagTypeFilter');
            const tagSelect = document.getElementById('tagFilter');
            const sourceSelect = document.getElementById('sourceFilter');
            
            // ä¿å­˜å½“å‰é€‰ä¸­å€¼
            const currentCountry = countrySelect.value;
            const currentCity = citySelect.value;
            const currentCategory = categorySelect.value;
            const currentTagType = tagTypeSelect ? tagTypeSelect.value : '';
            const currentTag = tagSelect.value;
            const currentSource = sourceSelect ? sourceSelect.value : '';
            
            // æ›´æ–°å›½å®¶é€‰é¡¹
            countrySelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
            filterOptions.countries.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                option.textContent = `${c.name} (${c.count})`;
                option.selected = c.name === currentCountry;
                countrySelect.appendChild(option);
            });
            
            // æ›´æ–°åŸå¸‚é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶ï¼‰
            updateCityOptions(currentCountry, currentCity);
            
            // æ›´æ–°åˆ†ç±»é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶ï¼‰
            updateCategoryOptions(currentCountry, currentCategory);
            
            // æ›´æ–°æ ‡ç­¾ç±»å‹é€‰é¡¹
            updateTagTypeOptions(currentTagType);
            
            // æ›´æ–°æ ‡ç­¾é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶ã€åˆ†ç±»å’Œæ ‡ç­¾ç±»å‹ï¼‰
            updateTagOptions(currentCountry, currentCategory, currentTagType, currentTag);
            
            // æ›´æ–°æ¥æºé€‰é¡¹
            if (sourceSelect && filterOptions.sources) {
                sourceSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
                filterOptions.sources.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.name;
                    option.textContent = `${s.name} (${s.count})`;
                    option.selected = s.name === currentSource;
                    sourceSelect.appendChild(option);
                });
            }
            
            // æ›´æ–°ç¼–è¾‘è¡¨å•çš„åŸå¸‚/å›½å®¶ä¸‹æ‹‰é€‰é¡¹
            updatePlaceFormOptions();
        }
        
        // æ›´æ–°åŸå¸‚é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶ï¼‰
        function updateCityOptions(selectedCountry, currentCity) {
            const citySelect = document.getElementById('city');
            citySelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
            
            if (selectedCountry && filterOptions.citiesByCountry[selectedCountry]) {
                // åªæ˜¾ç¤ºé€‰ä¸­å›½å®¶çš„åŸå¸‚
                filterOptions.citiesByCountry[selectedCountry].forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.name;
                    option.textContent = `${c.name} (${c.count})`;
                    option.selected = c.name === currentCity;
                    citySelect.appendChild(option);
                });
            } else {
                // æ˜¾ç¤ºæ‰€æœ‰åŸå¸‚
                const allCities = [];
                Object.values(filterOptions.citiesByCountry).forEach(cities => {
                    cities.forEach(c => allCities.push(c));
                });
                // æŒ‰åç§°æ’åºå¹¶å»é‡
                const uniqueCities = {};
                allCities.forEach(c => {
                    if (!uniqueCities[c.name]) {
                        uniqueCities[c.name] = c.count;
                    } else {
                        uniqueCities[c.name] += c.count;
                    }
                });
                Object.entries(uniqueCities)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .forEach(([name, count]) => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = `${name} (${count})`;
                        option.selected = name === currentCity;
                        citySelect.appendChild(option);
                    });
            }
        }
        
        // æ›´æ–°åˆ†ç±»é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶ï¼‰
        function updateCategoryOptions(selectedCountry, currentCategory) {
            const categorySelect = document.getElementById('category');
            categorySelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
            
            let categoriesToShow = [];
            
            if (selectedCountry && filterOptions.categoriesByCountry && filterOptions.categoriesByCountry[selectedCountry]) {
                // åªæ˜¾ç¤ºé€‰ä¸­å›½å®¶çš„åˆ†ç±»
                categoriesToShow = filterOptions.categoriesByCountry[selectedCountry];
            } else if (filterOptions.categories) {
                // æ˜¾ç¤ºæ‰€æœ‰åˆ†ç±»
                categoriesToShow = filterOptions.categories;
            }
            
            categoriesToShow.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                option.textContent = `${c.name} (${c.count})`;
                option.selected = c.name === currentCategory;
                categorySelect.appendChild(option);
            });
        }
        
        // æ›´æ–°æ ‡ç­¾ç±»å‹é€‰é¡¹
        function updateTagTypeOptions(currentTagType) {
            const tagTypeSelect = document.getElementById('tagTypeFilter');
            if (!tagTypeSelect) return;
            
            tagTypeSelect.innerHTML = '<option value="">All Types</option>';
            
            // å¦‚æœåç«¯è¿”å›çš„ tagsByType éƒ½æ˜¯ "other"ï¼Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºåˆ†ç»„
            let tagsByType = [];
            if (filterOptions.tagsByType && filterOptions.tagsByType.length > 0) {
                // æ£€æŸ¥æ˜¯å¦å¤§éƒ¨åˆ†æ ‡ç­¾éƒ½è¢«åˆ†ç±»ä¸º "other"ï¼ˆè¶…è¿‡90%ï¼‰
                const otherGroup = filterOptions.tagsByType.find(g => g.type === 'other');
                const totalTags = filterOptions.tags ? filterOptions.tags.length : 0;
                const otherTagsCount = otherGroup && otherGroup.tags ? otherGroup.tags.length : 0;
                
                // å¦‚æœè¶…è¿‡90%çš„æ ‡ç­¾éƒ½æ˜¯ "other"ï¼Œè¯´æ˜åç«¯åˆ†ç±»ä¸å‡†ç¡®ï¼Œä½¿ç”¨å‰ç«¯åˆ†ç±»
                const needsFrontendClassification = totalTags > 0 && (otherTagsCount / totalTags) > 0.9;
                
                if (needsFrontendClassification && filterOptions.tags) {
                    console.log('âš ï¸ åç«¯åˆ†ç±»ä¸å‡†ç¡®ï¼Œä½¿ç”¨å‰ç«¯åˆ†ç±»é€»è¾‘');
                    tagsByType = createTagTypeGroups(filterOptions.tags);
                } else {
                    tagsByType = filterOptions.tagsByType;
                }
            } else if (filterOptions.tags) {
                // å¦‚æœåç«¯æ²¡æœ‰è¿”å› tagsByTypeï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„åˆ†ç±»é€»è¾‘
                tagsByType = createTagTypeGroups(filterOptions.tags);
            }
            
            // ä¿å­˜åˆ° filterOptions ä»¥ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
            filterOptions.tagsByType = tagsByType;
            
            tagsByType.forEach(typeInfo => {
                const option = document.createElement('option');
                option.value = typeInfo.type;
                option.textContent = `${typeInfo.label} (${typeInfo.count})`;
                option.selected = typeInfo.type === currentTagType;
                tagTypeSelect.appendChild(option);
            });
        }
        
        // æ›´æ–°æ ‡ç­¾é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶ã€åˆ†ç±»å’Œæ ‡ç­¾ç±»å‹ï¼‰
        function updateTagOptions(selectedCountry, selectedCategory, selectedTagType, currentTag) {
            const tagSelect = document.getElementById('tagFilter');
            tagSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
            
            let tagsToShow = [];
            
            // ä¼˜å…ˆçº§ï¼šåˆ†ç±» > å›½å®¶ > å…¨å±€
            if (selectedCategory && filterOptions.tagsByCategory && filterOptions.tagsByCategory[selectedCategory]) {
                // åªæ˜¾ç¤ºé€‰ä¸­åˆ†ç±»çš„æ ‡ç­¾
                tagsToShow = filterOptions.tagsByCategory[selectedCategory];
            } else if (selectedCountry && filterOptions.tagsByCountry && filterOptions.tagsByCountry[selectedCountry]) {
                // åªæ˜¾ç¤ºé€‰ä¸­å›½å®¶çš„æ ‡ç­¾
                tagsToShow = filterOptions.tagsByCountry[selectedCountry];
            } else if (filterOptions.tags) {
                // æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                tagsToShow = filterOptions.tags;
            }
            
            // å¦‚æœé€‰æ‹©äº†æ ‡ç­¾ç±»å‹ï¼Œè¿›ä¸€æ­¥ç­›é€‰
            if (selectedTagType && filterOptions.tagsByType) {
                const typeInfo = filterOptions.tagsByType.find(t => t.type === selectedTagType);
                if (typeInfo && typeInfo.tags) {
                    // è·å–è¯¥ç±»å‹ä¸‹çš„æ‰€æœ‰æ ‡ç­¾åç§°
                    const typeTagNames = new Set(typeInfo.tags.map(t => t.name));
                    // åªä¿ç•™å±äºè¯¥ç±»å‹çš„æ ‡ç­¾
                    tagsToShow = tagsToShow.filter(t => typeTagNames.has(t.name));
                }
            }
            
            tagsToShow.forEach(t => {
                const option = document.createElement('option');
                option.value = t.name;
                // å°è¯•å»æ‰å‰ç¼€æ˜¾ç¤º
                const displayName = getTagDisplayName(t.name);
                option.textContent = `${displayName} (${t.count})`;
                option.selected = t.name === currentTag;
                tagSelect.appendChild(option);
            });
        }
        
        // ä»æ ‡ç­¾ä¸­æå–æ˜¾ç¤ºåç§°ï¼ˆå»æ‰å‰ç¼€ï¼‰
        function getTagDisplayName(tag) {
            const prefixes = [
                'architect:', 'style:', 'theme:', 'pritzker_year:', 
                'domain:', 'meal:', 'shop:', 'type:'
            ];
            
            for (const prefix of prefixes) {
                if (tag.toLowerCase().startsWith(prefix.toLowerCase())) {
                    return tag.substring(prefix.length);
                }
            }
            
            // ç‰¹æ®Šå¤„ç† pritzkerï¼ˆæ²¡æœ‰å†’å·ï¼‰
            if (tag.toLowerCase() === 'pritzker') {
                return tag;
            }
            
            return tag;
        }
        
        // ç®€å•çš„æ ‡ç­¾ç±»å‹è¯†åˆ«ï¼ˆåŸºäºå†…å®¹ç‰¹å¾ï¼Œå› ä¸ºæ•°æ®åº“ä¸­çš„æ ‡ç­¾æ²¡æœ‰å‰ç¼€ï¼‰
        function guessTagType(tag) {
            const lowerTag = tag.toLowerCase();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å‰ç¼€ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
            if (lowerTag.startsWith('architect:')) return 'architect';
            if (lowerTag.startsWith('style:')) return 'style';
            if (lowerTag.startsWith('theme:')) return 'theme';
            if (lowerTag.startsWith('domain:')) return 'domain';
            if (lowerTag.startsWith('meal:')) return 'meal';
            if (lowerTag.startsWith('shop:')) return 'shop';
            if (lowerTag.startsWith('type:')) return 'type';
            
            // å¥–é¡¹æ£€æµ‹ï¼ˆç¬¬äºŒä¼˜å…ˆçº§ï¼‰
            if (lowerTag === 'pritzker' || lowerTag.startsWith('pritzker_year:') || lowerTag.startsWith('pritzker ')) {
                return 'award';
            }
            
            // é£æ ¼å…³é”®è¯ï¼ˆç¬¬ä¸‰ä¼˜å…ˆçº§ï¼‰- æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œæ›´å…·ä½“çš„åœ¨å‰é¢
            const styleKeywords = [
                'architectural style', 'architectural', 
                'brutalism', 'brutalist', 'modernism', 'modernist', 'postmodernism', 'postmodernist',
                'minimalism', 'minimalist', 'baroque', 'gothic', 'renaissance', 'romanesque',
                'art nouveau', 'art deco', 'expressionism', 'expressionist', 'futurism', 'futurist',
                'constructivism', 'constructivist', 'deconstructivism', 'deconstructivist',
                'neoclassicism', 'neoclassical', 'classical', 'contemporary',
                'industrial', 'organic', 'parametric', 'high-tech', 'metabolism', 'metabolist',
                'international style', 'bauhaus', 'prairie school', 'arts and crafts',
                'victorian', 'edwardian', 'georgian', 'colonial', 'federal',
                'beaux-arts', 'chicago school', 'streamline moderne', 'googie',
                'academic art', 'abstract', 'cubism', 'surrealism', 'impressionism',
                'revival', 'neo-', 'neo ', '-ism', 'esque', 'traditional'
            ];
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«é£æ ¼å…³é”®è¯
            for (const keyword of styleKeywords) {
                if (lowerTag.includes(keyword)) {
                    return 'style';
                }
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼šå•ç‹¬çš„ "architecture" æˆ–åŒ…å« "architecture" ä½†ä¸æ˜¯å…¬å¸å
            // å¦‚æœæ ‡ç­¾åŒ…å« "Architecture"ï¼ˆå¤§å†™Aï¼‰ï¼Œå¾ˆå¯èƒ½æ˜¯å…¬å¸åï¼Œè·³è¿‡é£æ ¼æ£€æµ‹
            if (lowerTag.includes('architecture') && !tag.includes('Architecture')) {
                // å°å†™çš„ architectureï¼Œå¯èƒ½æ˜¯é£æ ¼æè¿°
                return 'style';
            }
            
            // ä¸»é¢˜å…³é”®è¯ - åŒ…æ‹¬å¢“åœ°ç›¸å…³çš„äººç‰©ç±»å‹
            const themeKeywords = [
                'feminism', 'feminist', 'sustainability', 'ecology', 'social',
                'musician', 'artist', 'scientist', 'writer', 'poet', 'composer',
                'painter', 'sculptor', 'philosopher', 'politician', 'actor', 'actress',
                'director', 'filmmaker', 'photographer', 'journalist', 'historian',
                'mathematician', 'physicist', 'chemist', 'biologist', 'inventor',
                'explorer', 'military', 'general', 'admiral', 'revolutionary',
                'religious', 'saint', 'martyr', 'nobel', 'laureate'
            ];
            for (const keyword of themeKeywords) {
                if (lowerTag.includes(keyword)) {
                    return 'theme';
                }
            }
            
            // é¤é¥®å…³é”®è¯
            const mealKeywords = ['brunch', 'breakfast', 'lunch', 'dinner', 'cafe', 'coffee', 'restaurant'];
            for (const keyword of mealKeywords) {
                if (lowerTag.includes(keyword)) {
                    return 'meal';
                }
            }
            
            // é¢†åŸŸå…³é”®è¯
            const domainKeywords = ['domain:', 'science', 'wissenschaft'];
            for (const keyword of domainKeywords) {
                if (lowerTag.includes(keyword)) {
                    return 'domain';
                }
            }
            
            // å•†åº—å…³é”®è¯ï¼ˆæ³¨æ„ï¼švintage å¯èƒ½æ˜¯é£æ ¼ä¹Ÿå¯èƒ½æ˜¯å•†åº—ç±»å‹ï¼Œè¿™é‡Œæ”¾åœ¨åé¢ï¼‰
            const shopKeywords = ['secondhand', 'thrift', 'boutique'];
            for (const keyword of shopKeywords) {
                if (lowerTag.includes(keyword)) {
                    return 'shop';
                }
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼šå•ç‹¬çš„ "vintage" æˆ– "Vintage" ä½œä¸ºå•†åº—ç±»å‹
            if (lowerTag === 'vintage') {
                return 'shop';
            }
            
            // å»ºç­‘å¸ˆåå­—è¯†åˆ«ï¼ˆæœ€åæ£€æµ‹ï¼Œå› ä¸ºæœ€ä¸ç¡®å®šï¼‰
            // 1. åŒ…å«å¤§å†™å­—æ¯å’Œç©ºæ ¼æˆ–ç‚¹å·
            // 2. ä¸åŒ…å«å¸¸è§çš„éäººåè¯æ±‡
            const nonNameWords = ['architecture', 'architects', 'studio', 'associates', 'partners', 
                                 'group', 'design', 'office', 'workshop', 'collective', 'company',
                                 'administration', 'progress', 'works'];
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«éäººåè¯æ±‡
            const hasNonNameWord = nonNameWords.some(word => lowerTag.includes(word));
            
            if (!hasNonNameWord) {
                // æ£€æŸ¥æ˜¯å¦ç¬¦åˆäººåæ ¼å¼
                // 1. åŒ…å«è‡³å°‘ä¸€ä¸ªå¤§å†™å­—æ¯
                // 2. åŒ…å«ç©ºæ ¼æˆ–ç‚¹å·
                // 3. é•¿åº¦åœ¨ 3-50 ä¹‹é—´
                if (/[A-Z]/.test(tag) && (/\s/.test(tag) || /\./.test(tag)) && tag.length >= 3 && tag.length <= 50) {
                    // è¿›ä¸€æ­¥æ£€æŸ¥ï¼šè‡³å°‘æœ‰ä¸¤ä¸ªå•è¯ï¼Œä¸”æ¯ä¸ªå•è¯é¦–å­—æ¯å¤§å†™
                    const words = tag.split(/[\s.]+/).filter(w => w.length > 0);
                    if (words.length >= 2) {
                        // æ£€æŸ¥æ˜¯å¦å¤§éƒ¨åˆ†å•è¯é¦–å­—æ¯å¤§å†™
                        const capitalizedWords = words.filter(w => /^[A-Z]/.test(w));
                        if (capitalizedWords.length >= words.length * 0.5) {
                            return 'architect';
                        }
                    }
                }
            }
            
            // å…¶ä»–
            return 'other';
        }
        
        // æ‰‹åŠ¨åˆ›å»ºæ ‡ç­¾ç±»å‹åˆ†ç»„ï¼ˆå› ä¸ºåç«¯è¿”å›çš„éƒ½æ˜¯ "other"ï¼‰
        function createTagTypeGroups(tags) {
            console.log('ğŸ” å¼€å§‹åˆ†ç±»æ ‡ç­¾ï¼Œæ€»æ•°:', tags.length);
            
            const groups = {
                architect: { type: 'architect', label: 'Architect', labelZh: 'å»ºç­‘å¸ˆ', count: 0, tags: [] },
                style: { type: 'style', label: 'Style', labelZh: 'é£æ ¼', count: 0, tags: [] },
                theme: { type: 'theme', label: 'Theme', labelZh: 'ä¸»é¢˜', count: 0, tags: [] },
                award: { type: 'award', label: 'Award', labelZh: 'å¥–é¡¹', count: 0, tags: [] },
                domain: { type: 'domain', label: 'Domain', labelZh: 'é¢†åŸŸ', count: 0, tags: [] },
                meal: { type: 'meal', label: 'Meal', labelZh: 'é¤é¥®', count: 0, tags: [] },
                shop: { type: 'shop', label: 'Shop', labelZh: 'å•†åº—', count: 0, tags: [] },
                type: { type: 'type', label: 'Type', labelZh: 'ç±»å‹', count: 0, tags: [] },
                other: { type: 'other', label: 'Other', labelZh: 'å…¶ä»–', count: 0, tags: [] }
            };
            
            // ç”¨äºè°ƒè¯•çš„æ ·æœ¬è®¡æ•°
            const samples = { architect: [], style: [], other: [] };
            
            tags.forEach(tag => {
                const tagType = guessTagType(tag.name);
                const displayName = getTagDisplayName(tag.name);
                
                // æ”¶é›†æ ·æœ¬ç”¨äºè°ƒè¯•
                if (samples[tagType] && samples[tagType].length < 5) {
                    samples[tagType].push(tag.name);
                }
                
                groups[tagType].tags.push({
                    name: tag.name,
                    displayName: displayName,
                    type: tagType,
                    count: tag.count
                });
                groups[tagType].count += tag.count;
            });
            
            // æ‰“å°è°ƒè¯•ä¿¡æ¯
            console.log('ğŸ“Š åˆ†ç±»ç»“æœç»Ÿè®¡:');
            Object.values(groups).forEach(g => {
                if (g.count > 0) {
                    console.log(`  ${g.labelZh} (${g.type}): ${g.tags.length} ä¸ªæ ‡ç­¾, ${g.count} æ¬¡ä½¿ç”¨`);
                }
            });
            console.log('ğŸ“ æ ·æœ¬:');
            console.log('  å»ºç­‘å¸ˆæ ·æœ¬:', samples.architect);
            console.log('  é£æ ¼æ ·æœ¬:', samples.style);
            console.log('  å…¶ä»–æ ·æœ¬:', samples.other.slice(0, 10));
            
            // åªè¿”å›æœ‰æ ‡ç­¾çš„ç±»å‹
            const result = Object.values(groups).filter(g => g.count > 0);
            console.log('âœ… è¿”å›', result.length, 'ä¸ªç±»å‹');
            return result;
        }
        
        // å½“æ ‡ç­¾ç±»å‹æ”¹å˜æ—¶æ›´æ–°æ ‡ç­¾åˆ—è¡¨
        function updateTagsByType() {
            const selectedCountry = document.getElementById('country').value;
            const selectedCategory = document.getElementById('category').value;
            const selectedTagType = document.getElementById('tagTypeFilter').value;
            const currentTag = document.getElementById('tagFilter').value;
            updateTagOptions(selectedCountry, selectedCategory, selectedTagType, currentTag);
        }
        
        // æ›´æ–°æ ‡ç­¾é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶å’Œåˆ†ç±»ï¼‰
        function updateTagOptions_old(selectedCountry, selectedCategory, currentTag) {
            const tagSelect = document.getElementById('tagFilter');
            tagSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
            
            let tagsToShow = [];
            
            // ä¼˜å…ˆçº§ï¼šåˆ†ç±» > å›½å®¶ > å…¨å±€
            if (selectedCategory && filterOptions.tagsByCategory && filterOptions.tagsByCategory[selectedCategory]) {
                // åªæ˜¾ç¤ºé€‰ä¸­åˆ†ç±»çš„æ ‡ç­¾
                tagsToShow = filterOptions.tagsByCategory[selectedCategory];
            } else if (selectedCountry && filterOptions.tagsByCountry && filterOptions.tagsByCountry[selectedCountry]) {
                // åªæ˜¾ç¤ºé€‰ä¸­å›½å®¶çš„æ ‡ç­¾
                tagsToShow = filterOptions.tagsByCountry[selectedCountry];
            } else if (filterOptions.tags) {
                // æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
                tagsToShow = filterOptions.tags;
            }
            
            tagsToShow.forEach(t => {
                const option = document.createElement('option');
                option.value = t.name;
                option.textContent = `${t.name} (${t.count})`;
                option.selected = t.name === currentTag;
                tagSelect.appendChild(option);
            });
        }

        // æ›´æ–°ç­›é€‰é€‰é¡¹ï¼ˆæ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶ï¼‰- ç®€åŒ–ç‰ˆ
        function updateFilterOptions() {
            const selectedCountry = document.getElementById('country').value;
            const selectedCategory = document.getElementById('category').value;
            const selectedTagType = document.getElementById('tagTypeFilter').value;
            const currentCity = document.getElementById('city').value;
            const currentTag = document.getElementById('tagFilter').value;
            updateCityOptions(selectedCountry, currentCity);
            updateCategoryOptions(selectedCountry, selectedCategory);
            updateTagOptions(selectedCountry, selectedCategory, selectedTagType, currentTag);
        }

        // æ›´æ–°ç¼–è¾‘è¡¨å•çš„åŸå¸‚/å›½å®¶ä¸‹æ‹‰é€‰é¡¹
        function updatePlaceFormOptions() {
            // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨æ•°æ®
            updatePlaceFormDropdowns();
        }
        
        // åŸå¸‚ä¸‹æ‹‰åˆ—è¡¨ç›¸å…³å‡½æ•°
        let allCitiesForDropdown = [];
        let allCountriesForDropdown = [];
        
        // æ›´æ–°ç¼–è¾‘è¡¨å•çš„åŸå¸‚é€‰é¡¹ï¼ˆæ ¹æ®é€‰ä¸­çš„å›½å®¶ï¼‰- å…¼å®¹æ—§è°ƒç”¨
        function updatePlaceCityOptions() {
            updateCityDropdownOptions();
        }
        
        function updatePlaceFormDropdowns() {
            // æ›´æ–°å›½å®¶åˆ—è¡¨
            allCountriesForDropdown = [];
            if (filterOptions.countries) {
                allCountriesForDropdown = filterOptions.countries.map(c => c.name).sort();
            }
            
            // æ›´æ–°åŸå¸‚åˆ—è¡¨
            updateCityDropdownOptions();
        }
        
        function updateCityDropdownOptions() {
            const selectedCountry = document.getElementById('placeCountry').value.trim();
            allCitiesForDropdown = [];
            
            if (selectedCountry && filterOptions.citiesByCountry && filterOptions.citiesByCountry[selectedCountry]) {
                allCitiesForDropdown = filterOptions.citiesByCountry[selectedCountry].map(c => c.name).sort();
            } else if (filterOptions.citiesByCountry) {
                const allCities = new Set();
                Object.values(filterOptions.citiesByCountry).forEach(cities => {
                    cities.forEach(c => allCities.add(c.name));
                });
                allCitiesForDropdown = Array.from(allCities).sort();
            }
        }
        
        function showCityDropdown() {
            updateCityDropdownOptions();
            renderCityDropdown(allCitiesForDropdown);
        }
        
        function toggleCityDropdown() {
            const dropdown = document.getElementById('placeCityDropdown');
            if (dropdown.style.display === 'none') {
                showCityDropdown();
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        function filterCityDropdown(query) {
            updateCityDropdownOptions();
            const filtered = allCitiesForDropdown.filter(c => 
                c.toLowerCase().includes(query.toLowerCase())
            );
            renderCityDropdown(filtered);
        }
        
        function renderCityDropdown(cities) {
            const dropdown = document.getElementById('placeCityDropdown');
            dropdown.innerHTML = '';
            cities.slice(0, 50).forEach(city => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = city;
                item.onclick = () => selectCity(city);
                dropdown.appendChild(item);
            });
            dropdown.style.display = cities.length > 0 ? 'block' : 'none';
        }
        
        function selectCity(city) {
            document.getElementById('placeCity').value = city;
            document.getElementById('placeCityDropdown').style.display = 'none';
        }
        
        function showCountryDropdown() {
            renderCountryDropdown(allCountriesForDropdown);
        }
        
        function toggleCountryDropdown() {
            const dropdown = document.getElementById('placeCountryDropdown');
            if (dropdown.style.display === 'none') {
                showCountryDropdown();
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        function filterCountryDropdown(query) {
            const filtered = allCountriesForDropdown.filter(c => 
                c.toLowerCase().includes(query.toLowerCase())
            );
            renderCountryDropdown(filtered);
        }
        
        function renderCountryDropdown(countries) {
            const dropdown = document.getElementById('placeCountryDropdown');
            dropdown.innerHTML = '';
            countries.slice(0, 50).forEach(country => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = country;
                item.onclick = () => selectCountry(country);
                dropdown.appendChild(item);
            });
            dropdown.style.display = countries.length > 0 ? 'block' : 'none';
        }
        
        function selectCountry(country) {
            document.getElementById('placeCountry').value = country;
            document.getElementById('placeCountryDropdown').style.display = 'none';
            updatePlaceCityOptions();
            updateCityDropdownOptions();
        }
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰åˆ—è¡¨
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-list').forEach(d => d.style.display = 'none');
            }
        });

        // ç›‘å¬ç­›é€‰å™¨å˜åŒ–
        function setupFilterListeners() {
            document.getElementById('country').addEventListener('change', function() {
                filters.country = this.value || undefined;
                delete filters.city; // æ¸…é™¤åŸå¸‚ç­›é€‰
                document.getElementById('city').value = '';
                updateFilterOptions();
            });

            document.getElementById('city').addEventListener('change', function() {
                filters.city = this.value || undefined;
            });

            document.getElementById('category').addEventListener('change', function() {
                filters.category = this.value || undefined;
            });
        }

        // åŠ è½½åœ°ç‚¹åˆ—è¡¨
        async function loadPlaces() {
            try {
                showLoading();

                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 20,
                    includeInternalTags: 'true',  // åå°ç®¡ç†éœ€è¦å®Œæ•´çš„ tags å­—æ®µ
                    ...filters
                });

                const response = await fetchWithTimeout(`${API_BASE}?${params}`);
                const result = await response.json();

                if (result.success) {
                    renderPlaces(result.data);
                    renderPagination(result.pagination);
                    renderStats(result.pagination);
                    updateActiveFilters();
                } else {
                    showEmpty();
                }
            } catch (error) {
                console.error('åŠ è½½åœ°ç‚¹å¤±è´¥:', error);
                document.getElementById('loading').textContent = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ /api/public-places';
                showEmpty();
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('empty').style.display = 'none';
            document.getElementById('placesTable').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }

        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmpty() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('empty').style.display = 'block';
            document.getElementById('placesTable').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }

        // æ¸²æŸ“åœ°ç‚¹åˆ—è¡¨
        function renderPlaces(places) {
            const tbody = document.getElementById('placesBody');
            tbody.innerHTML = '';

            if (places.length === 0) {
                showEmpty();
                return;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('empty').style.display = 'none';
            document.getElementById('placesTable').style.display = 'table';

            places.forEach(place => {
                const tr = document.createElement('tr');
                
                // ç…§ç‰‡åˆ— - ä½¿ç”¨ coverImage å­—æ®µ
                let photoHtml = '';
                if (place.coverImage) {
                    photoHtml = `<img src="${place.coverImage}" class="photo" alt="${place.name}" onclick="window.open('${place.coverImage}', '_blank')" onerror="this.outerHTML='<div class=\\'photo-placeholder\\'>ğŸ“·</div>'">`;
                } else {
                    photoHtml = '<div class="photo-placeholder">ğŸ“·</div>';
                }
                
                // è§£æè¥ä¸šæ—¶é—´ JSON å­—æ®µ
                let openingHoursHtml = '-';
                if (place.openingHours) {
                    try {
                        const hours = typeof place.openingHours === 'string' ? JSON.parse(place.openingHours) : place.openingHours;
                        if (hours && hours.weekday_text && Array.isArray(hours.weekday_text)) {
                            // Google Maps æ ¼å¼çš„è¥ä¸šæ—¶é—´
                            openingHoursHtml = '<ul class="opening-hours-list">' + 
                                hours.weekday_text.slice(0, 7).map(t => `<li>${t}</li>`).join('') + 
                                '</ul>';
                        } else if (Array.isArray(hours)) {
                            // æ•°ç»„æ ¼å¼ [{day, hours}, ...]
                            openingHoursHtml = '<ul class="opening-hours-list">' + 
                                hours.slice(0, 7).map(t => {
                                    if (typeof t === 'object' && t.day && t.hours) {
                                        return `<li>${t.day}: ${t.hours}</li>`;
                                    }
                                    return `<li>${typeof t === 'string' ? t : ''}</li>`;
                                }).join('') + 
                                '</ul>';
                        } else if (typeof hours === 'string') {
                            openingHoursHtml = `<span style="font-size:11px;">${hours}</span>`;
                        } else if (typeof hours === 'object') {
                            // å°è¯•æå– periods æˆ–å…¶ä»–æ ¼å¼
                            if (hours.periods && Array.isArray(hours.periods)) {
                                openingHoursHtml = '<span style="font-size:11px;">æœ‰è¥ä¸šæ—¶é—´æ•°æ®</span>';
                            } else {
                                openingHoursHtml = '<span style="font-size:11px;">æœ‰è¥ä¸šæ—¶é—´</span>';
                            }
                        }
                    } catch { openingHoursHtml = '-'; }
                }
                
                // è§£ææ ‡ç­¾ - ä¼˜å…ˆä½¿ç”¨åç«¯è®¡ç®—å¥½çš„ display_tags_en
                let tagsHtml = '-';
                
                // ä¼˜å…ˆä½¿ç”¨ display_tags_enï¼ˆåç«¯å·²ç»åˆå¹¶äº† tags + aiTagsï¼‰
                if (place.display_tags_en && Array.isArray(place.display_tags_en) && place.display_tags_en.length > 0) {
                    tagsHtml = '<div class="tag-container">' + 
                        place.display_tags_en.map(t => `<span class="tag tag-info">${t}</span>`).join('') + 
                        '</div>';
                } else {
                    // å›é€€ï¼šå°è¯•è§£æ aiTags
                    const tagsData = place.aiTags;
                    if (tagsData) {
                        try {
                            const tagArr = typeof tagsData === 'string' ? JSON.parse(tagsData) : tagsData;
                            if (Array.isArray(tagArr) && tagArr.length > 0) {
                                // æå– en å­—æ®µï¼Œå¦‚æœæ˜¯å¯¹è±¡çš„è¯
                                const tagStrings = tagArr.map(t => {
                                    if (typeof t === 'object' && t !== null && t.en) {
                                        return t.en;
                                    }
                                    return typeof t === 'string' ? t : '';
                                }).filter(Boolean);
                                
                                if (tagStrings.length > 0) {
                                    tagsHtml = '<div class="tag-container">' + 
                                        tagStrings.map(t => `<span class="tag tag-info">${t}</span>`).join('') + 
                                        '</div>';
                                }
                            }
                        } catch { tagsHtml = '-'; }
                    }
                }
                
                // ä»·æ ¼ç­‰çº§
                let priceLevel = '-';
                if (place.price) {
                    // ä¼˜å…ˆæ˜¾ç¤º price æ–‡æœ¬ï¼ˆå¦‚ â‚¬10â€“20ï¼‰
                    priceLevel = place.price;
                } else if (place.priceLevel !== null && place.priceLevel !== undefined && place.priceLevel > 0) {
                    priceLevel = 'ğŸ’°'.repeat(place.priceLevel);
                } else if (place.priceLevel === 0) {
                    priceLevel = 'å…è´¹';
                }
                
                // è”ç³»æ–¹å¼
                let contact = '';
                if (place.website) {
                    contact += `<a href="${place.website}" target="_blank" style="color:#667eea;font-size:12px;">ğŸŒ ç½‘ç«™</a><br>`;
                }
                if (place.phoneNumber) {
                    contact += `<span style="font-size:12px;">ğŸ“ ${place.phoneNumber}</span>`;
                }
                if (!contact) contact = '-';
                
                // æè¿°/æ‘˜è¦ - æ”¯æŒæŠ˜è¡Œå±•ç¤º
                let description = '-';
                const descText = place.description || place.aiSummary || '';
                if (descText) {
                    description = descText.length > 100 ? descText.substring(0, 100) + '...' : descText;
                }
                
                // æ¥æº
                let source = place.source || '-';
                const sourceLabels = {
                    'google_maps': 'Google Maps',
                    'google_maps_link': 'Googleé“¾æ¥',
                    'ai_image': 'AIå›¾ç‰‡',
                    'ai_chat': 'AIå¯¹è¯',
                    'manual': 'æ‰‹åŠ¨æ·»åŠ ',
                    'app_wishlist': 'åº”ç”¨'
                };
                source = sourceLabels[source] || source;
                
                // åˆ›å»ºæ—¶é—´
                const createdAt = place.createdAt ? new Date(place.createdAt).toLocaleDateString('zh-CN') : '-';
                
                // è½¬ä¹‰ place æ•°æ®ç”¨äº onclick
                const placeId = place.id;
                
                tr.innerHTML = `
                    <td class="nowrap-cell">${photoHtml}</td>
                    <td class="wrap-cell">
                        <div class="place-name">${place.name || ''}</div>
                        ${place.address ? `<div class="place-address">${place.address}</div>` : ''}
                        ${place.googlePlaceId ? `<div style="font-size:10px;color:#999;">ID: ${place.googlePlaceId.substring(0, 20)}...</div>` : ''}
                    </td>
                    <td class="nowrap-cell">${place.city || '-'}</td>
                    <td class="nowrap-cell">${place.country || '-'}</td>
                    <td class="nowrap-cell" style="font-size:11px;color:#666;">
                        ${place.latitude ? place.latitude.toFixed(4) : '-'}, 
                        ${place.longitude ? place.longitude.toFixed(4) : '-'}
                    </td>
                    <td class="nowrap-cell">
                        ${place.rating 
                            ? `<span class="badge badge-rating"><span class="rating-star">â­</span>${place.rating.toFixed(1)} ${place.ratingCount ? `(${place.ratingCount})` : ''}</span>` 
                            : '-'}
                    </td>
                    <td class="nowrap-cell">
                        ${place.categoryEn || place.category 
                            ? `<span class="badge badge-category">${place.categoryEn || place.category}</span>` 
                            : '-'}
                    </td>
                    <td class="wrap-cell" style="font-size:12px;color:#666;">${description}</td>
                    <td class="wrap-cell" style="max-width:200px;">${openingHoursHtml}</td>
                    <td class="nowrap-cell">${priceLevel}</td>
                    <td class="wrap-cell" style="font-size:12px;">${contact}</td>
                    <td class="wrap-cell">${tagsHtml}</td>
                    <td class="nowrap-cell"><span class="badge badge-location">${source}</span></td>
                    <td class="nowrap-cell" style="font-size:11px;color:#999;">${createdAt}</td>
                    <td class="nowrap-cell">
                        <div class="action-btns">
                            <button class="btn btn-sm btn-secondary" onclick="openEditPlaceModal('${placeId}')">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" data-id="${placeId}" data-name="${(place.name || '').replace(/"/g, '&quot;')}">åˆ é™¤</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
                
                // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtn = tr.querySelector('.btn-danger');
                if (deleteBtn) {
                    deleteBtn.onclick = function() {
                        deletePlace(this.dataset.id, this.dataset.name);
                    };
                }
            });
        }
        
        // åˆ é™¤åœ°ç‚¹
        async function deletePlace(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åœ°ç‚¹ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }
            
            try {
                const token = getTokenOrAlert();
                const res = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await res.json();
                
                if (res.ok && result.success) {
                    alert('åˆ é™¤æˆåŠŸ');
                    await loadPlaces();
                } else {
                    throw new Error(result.message || result.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                console.error('åˆ é™¤åœ°ç‚¹å¤±è´¥:', e);
                if (e.message !== 'not_logged_in') {
                    alert(`åˆ é™¤å¤±è´¥: ${e.message}`);
                }
            }
        }

        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            container.style.display = 'flex';

            currentPage = pagination.page;
            totalPages = pagination.pages;

            // é¦–é¡µæŒ‰é’®
            const firstBtn = document.createElement('button');
            firstBtn.textContent = 'â®ï¸ é¦–é¡µ';
            firstBtn.disabled = currentPage === 1;
            firstBtn.onclick = () => goToPage(1);
            container.appendChild(firstBtn);

            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â—€ï¸ ä¸Šä¸€é¡µ';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => goToPage(currentPage - 1);
            container.appendChild(prevBtn);

            // é¡µç é€‰æ‹©å™¨
            const pageSelect = document.createElement('select');
            pageSelect.className = 'page-select';
            for (let i = 1; i <= totalPages; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `ç¬¬ ${i} é¡µ`;
                option.selected = i === currentPage;
                pageSelect.appendChild(option);
            }
            pageSelect.onchange = (e) => goToPage(parseInt(e.target.value));
            container.appendChild(pageSelect);

            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'ä¸‹ä¸€é¡µ â–¶ï¸';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => goToPage(currentPage + 1);
            container.appendChild(nextBtn);

            // æœ«é¡µæŒ‰é’®
            const lastBtn = document.createElement('button');
            lastBtn.textContent = 'æœ«é¡µ â­ï¸';
            lastBtn.disabled = currentPage === totalPages;
            lastBtn.onclick = () => goToPage(totalPages);
            container.appendChild(lastBtn);
        }

        // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
        function renderStats(pagination) {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stats-info">
                    å…± <strong>${pagination.total}</strong> ä¸ªåœ°ç‚¹
                </div>
                <div class="stats-info">
                    ç¬¬ <strong>${pagination.page}</strong> / <strong>${pagination.pages}</strong> é¡µ
                </div>
            `;
        }

        // æ›´æ–°æ´»è·ƒç­›é€‰æ˜¾ç¤º
        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            container.innerHTML = '';

            const filterKeys = Object.keys(filters);
            if (filterKeys.length === 0) {
                container.classList.remove('show');
                return;
            }

            container.classList.add('show');

            const labels = {
                search: 'ğŸ” æœç´¢',
                country: 'ğŸŒ å›½å®¶',
                city: 'ğŸ™ï¸ åŸå¸‚',
                category: 'ğŸ·ï¸ åˆ†ç±»',
                minRating: 'â­ æœ€ä½è¯„åˆ†',
                maxRating: 'â­ æœ€é«˜è¯„åˆ†',
                source: 'ğŸ“¦ æ¥æº',
                hasCoverImage: 'ğŸ–¼ï¸ å°é¢å›¾'
            };

            filterKeys.forEach(key => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                let displayValue = filters[key];
                // ç‰¹æ®Šå¤„ç† hasCoverImage çš„æ˜¾ç¤º
                if (key === 'hasCoverImage') {
                    displayValue = filters[key] === 'true' ? 'æœ‰' : 'æ— ';
                }
                tag.innerHTML = `
                    ${labels[key]}: <strong>${displayValue}</strong>
                    <button onclick="removeFilter('${key}')">Ã—</button>
                `;
                container.appendChild(tag);
            });
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            // æ”¶é›†ç­›é€‰æ¡ä»¶
            const newFilters = {};

            const search = document.getElementById('search').value.trim();
            const country = document.getElementById('country').value;
            const city = document.getElementById('city').value;
            const category = document.getElementById('category').value;
            const minRating = document.getElementById('minRating').value;
            const maxRating = document.getElementById('maxRating').value;
            const tagFilter = document.getElementById('tagFilter').value.trim();
            const tagTypeFilter = document.getElementById('tagTypeFilter').value;
            const sourceFilter = document.getElementById('sourceFilter').value;
            const hasCoverImage = document.getElementById('hasCoverImage').value;
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            if (search) newFilters.search = search;
            if (tagFilter) newFilters.tag = tagFilter;
            if (tagTypeFilter) newFilters.tagType = tagTypeFilter;
            if (country) newFilters.country = country;
            if (city) newFilters.city = city;
            if (category) newFilters.category = category;
            if (minRating) newFilters.minRating = minRating;
            if (maxRating) newFilters.maxRating = maxRating;
            if (sourceFilter) newFilters.source = sourceFilter;
            if (hasCoverImage) newFilters.hasCoverImage = hasCoverImage;
            if (sortBy) newFilters.sortBy = sortBy;
            if (sortBy) newFilters.sortOrder = sortOrder;

            filters = newFilters;
            currentPage = 1;
            loadPlaces();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            filters = {};
            currentPage = 1;

            document.getElementById('search').value = '';
            document.getElementById('country').value = '';
            document.getElementById('city').value = '';
            document.getElementById('category').value = '';
            document.getElementById('minRating').value = '';
            document.getElementById('maxRating').value = '';
            document.getElementById('tagFilter').value = '';
            document.getElementById('sourceFilter').value = '';
            document.getElementById('hasCoverImage').value = '';
            document.getElementById('sortBy').value = '';
            document.getElementById('sortOrder').value = 'desc';

            updateFilterOptions();
            loadPlaces();
        }

        // ç§»é™¤å•ä¸ªç­›é€‰
        function removeFilter(key) {
            delete filters[key];
            // å¤„ç†ä¸åŒçš„å…ƒç´  ID
            const elementId = key === 'source' ? 'sourceFilter' : key;
            const element = document.getElementById(elementId);
            if (element) element.value = '';
            currentPage = 1;
            
            // å¦‚æœç§»é™¤çš„æ˜¯å›½å®¶ã€åŸå¸‚æˆ–åˆ†ç±»ï¼Œéœ€è¦æ›´æ–°ç­›é€‰é€‰é¡¹
            if (['country', 'city', 'category'].includes(key)) {
                updateFilterOptions();
            }
            
            loadPlaces();
        }

        // è·³è½¬é¡µé¢
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadPlaces();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        init();
        setupFilterListeners();

        // --- åˆé›†ç›¸å…³ ---
        async function loadCollections() {
            try {
                const listContainer = document.getElementById('collectionsListContainer');
                if (listContainer) listContainer.style.display = 'block';
                document.getElementById('collectionsLoading').style.display = 'block';
                document.getElementById('collectionsLoading').textContent = 'åŠ è½½ä¸­...';
                document.getElementById('collectionsEmpty').style.display = 'none';
                document.getElementById('collectionsTable').style.display = 'none';

                const headers = {};
                const token = getStoredToken();
                if (token) headers['Authorization'] = `Bearer ${token}`;
                // å³ä½¿æ²¡æœ‰ç™»å½•ä¹Ÿå¯ä»¥æŸ¥çœ‹åˆé›†åˆ—è¡¨ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´
                const res = await fetchWithTimeout(`${COLLECTION_API_BASE}?includeAll=true`, { headers }, 30000);
                const result = await res.json();
                if (result.success && Array.isArray(result.data)) {
                    collections = result.data;
                    renderCollections();
                    showCollectionsList();
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (e) {
                console.error('åŠ è½½åˆé›†å¤±è´¥:', e);
                document.getElementById('collectionsLoading').style.display = 'block';
                document.getElementById('collectionsLoading').textContent = `åŠ è½½å¤±è´¥: ${e.message || 'è¯·æ£€æŸ¥åç«¯ /api/collections æˆ–æ˜¯å¦å·²è®¾ç½®ç®¡ç†å‘˜ Token'}`;
                document.getElementById('collectionsEmpty').style.display = 'none';
                document.getElementById('collectionsTable').style.display = 'none';
            }
        }

        function renderCollections() {
            const body = document.getElementById('collectionsBody');
            body.innerHTML = '';

            if (collections.length === 0) {
                document.getElementById('collectionsLoading').style.display = 'none';
                document.getElementById('collectionsEmpty').style.display = 'block';
                document.getElementById('collectionsTable').style.display = 'none';
                return;
            }

            document.getElementById('collectionsLoading').style.display = 'none';
            document.getElementById('collectionsEmpty').style.display = 'none';
            document.getElementById('collectionsTable').style.display = 'table';

            collections.forEach(col => {
                const tr = document.createElement('tr');
                const count = Array.isArray(col.collectionSpots) ? col.collectionSpots.length : 0;
                const statusTag = col.isPublished 
                    ? '<span class="tag tag-success">å·²ä¸Šçº¿</span>'
                    : '<span class="tag tag-warning">æœªä¸Šçº¿</span>';
                tr.innerHTML = `
                    <td>${col.coverImage ? `<img src="${col.coverImage}" class="photo" alt="${col.name}" onerror="this.outerHTML='<div class=\\'photo-placeholder\\'>ğŸ“·</div>'">` : '<div class="photo-placeholder">ğŸ“·</div>'}</td>
                    <td class="place-name">${col.name}</td>
                    <td>${count}</td>
                    <td>${statusTag}</td>
                    <td>
                        ${col.description || '-'}
                        <div class="accordion">
                            <details>
                                <summary>åœ°ç‚¹åˆ—è¡¨ï¼ˆ${count}ï¼‰</summary>
                                <ul style="padding-left:16px;">
                                    ${(col.collectionSpots || []).map(cs => `<li>${cs.spot?.name || cs.spotId} - ${cs.spot?.city || ''} ${cs.spot?.address || ''}</li>`).join('')}
                                </ul>
                            </details>
                            ${(col.people ? (() => { try { const arr = JSON.parse(col.people); return `<details><summary>äººç‰©</summary><ul style=\"padding-left:16px;\">${arr.map((p)=>`<li>${p.name || ''}${p.link?` - <a href='${p.link}' target='_blank'>é“¾æ¥</a>`:''}</li>`).join('')}</ul></details>`; } catch { return ''; } })() : '')}
                            ${(col.works ? (() => { try { const arr = JSON.parse(col.works); return `<details><summary>ä½œå“</summary><ul style=\"padding-left:16px;\">${arr.map((w)=>`<li>${w.name || ''}${w.link?` - <a href='${w.link}' target='_blank'>é“¾æ¥</a>`:''}</li>`).join('')}</ul></details>`; } catch { return ''; } })() : '')}
                        </div>
                    </td>
                    <td>${col.createdAt ? new Date(col.createdAt).toLocaleString() : '-'}</td>
                    <td>
                        <div class="list-actions">
                            ${col.isPublished 
                                ? `<button class="btn btn-secondary" onclick="unpublishCollection('${col.id}')">ä¸‹çº¿</button>`
                                : `<button class="btn btn-primary" onclick="publishCollection('${col.id}')">ä¸Šçº¿</button>`}
                            ${col.isPublished 
                                ? `<button class="btn btn-secondary" disabled>å·²ä¸Šçº¿ä¸å¯ç¼–è¾‘</button>`
                                : `<button class="btn btn-secondary" onclick="startEditCollection('${col.id}')">ç¼–è¾‘</button>`}
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        function clearCollectionForm() {
            backToCollectionsList();
        }

        // åˆ›å»ºæ¨¡å¼
        function startCreateCollection() {
            clearCollectionForm();
            editingCollectionId = null; // ç¡®ä¿æ˜¯åˆ›å»ºæ¨¡å¼
            // åˆå§‹åŒ–åŸå§‹æ•°æ®ä¸ºç©ºï¼ˆåˆ›å»ºæ¨¡å¼ï¼‰
            originalCollectionData = {
                name: '',
                description: '',
                coverImage: '',
                spotIds: '',
                people: '[]',
                works: '[]'
            };
            document.getElementById('collectionFormHeader').style.display = 'block';
            document.getElementById('editModeTitle').textContent = 'åˆ›å»ºåˆé›†';
            document.getElementById('saveCollectionBtn').textContent = 'ä¿å­˜';
            showCollectionForm(true);
            showCollectionsList(false);
            // éšè—é¡¶éƒ¨ tab æ å’Œåˆ›å»ºæŒ‰é’®
            document.querySelector('.nav-tabs').style.display = 'none';
            document.querySelector('.collections-actions').style.display = 'none';
        }

        function showCollectionForm(show) {
            const container = document.getElementById('collectionFormContainer');
            if (!container) return;
            container.style.display = show ? 'block' : 'none';
        }

        function showCollectionsList(show = true) {
            const listContainer = document.getElementById('collectionsListContainer');
            if (listContainer) {
                listContainer.style.display = show ? 'block' : 'none';
            }
            if (show) {
                document.getElementById('collectionsLoading').style.display = 'none';
                document.getElementById('collectionsEmpty').style.display = 'none';
                document.getElementById('collectionsTable').style.display = 'table';
                showCollectionForm(false);
            }
        }

        async function createCollection() {
            let token;
            const name = document.getElementById('colName').value.trim();
            const description = document.getElementById('colDesc').value.trim();
            const coverImage = document.getElementById('colCover').value.trim();

            if (!name) return alert('åç§°å¿…å¡«');
            if (!coverImage) return alert('è¯·ä¸Šä¼ å°é¢å›¾');
            if (selectedSpots.length === 0) return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåœ°ç‚¹');

            try {
                token = getTokenOrAlert();
                const isEdit = !!editingCollectionId;
                
                const payload = { 
                    name, 
                    coverImage,
                    description: description || undefined, 
                    spotIds: selectedSpots.map(s => s.id),
                    people: peopleListData.length > 0 ? peopleListData : undefined,
                    works: worksListData.length > 0 ? worksListData : undefined,
                };
                
                console.log('å‘é€è¯·æ±‚:', {
                    url: isEdit ? `${COLLECTION_API_BASE}/${editingCollectionId}` : COLLECTION_API_BASE,
                    method: isEdit ? 'PUT' : 'POST',
                    payload: {
                        ...payload,
                        coverImage: payload.coverImage ? `${payload.coverImage.substring(0, 50)}...` : null,
                    }
                });
                
                const res = await fetch(isEdit ? `${COLLECTION_API_BASE}/${editingCollectionId}` : COLLECTION_API_BASE, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                console.log('APIå“åº”:', result);
                
                if (!res.ok) {
                    // HTTPé”™è¯¯çŠ¶æ€ç 
                    let errorMsg = 'åˆ›å»ºå¤±è´¥';
                    if (result.message) {
                        errorMsg = typeof result.message === 'string' ? result.message : JSON.stringify(result.message);
                    } else if (result.error) {
                        errorMsg = typeof result.error === 'string' ? result.error : JSON.stringify(result.error);
                    } else {
                        errorMsg = `HTTP ${res.status}: ${res.statusText}`;
                    }
                    console.error('åˆ›å»ºåˆé›†å¤±è´¥:', result);
                    alert(`åˆ›å»ºå¤±è´¥: ${errorMsg}`);
                    return;
                }
                
                if (result.success) {
                    // ç›´æ¥åˆ·æ–°æ•°æ®å¹¶è¿”å›åˆ—è¡¨ï¼Œä¸å¼¹çª—
                    await refreshCollections();
                    backToCollectionsList();
                } else {
                    let errorMsg = 'åˆ›å»ºå¤±è´¥';
                    if (result.message) {
                        errorMsg = typeof result.message === 'string' ? result.message : JSON.stringify(result.message);
                    } else if (result.error) {
                        errorMsg = typeof result.error === 'string' ? result.error : JSON.stringify(result.error);
                    }
                    console.error('åˆ›å»ºåˆé›†å¤±è´¥:', result);
                    alert(`åˆ›å»ºå¤±è´¥: ${errorMsg}`);
                }
            } catch (e) {
                console.error('åˆ›å»ºåˆé›†å¤±è´¥', e);
                const errorMsg = e instanceof Error ? e.message : (typeof e === 'string' ? e : JSON.stringify(e));
                alert(`åˆ›å»ºå¤±è´¥: ${errorMsg}\n\nè¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯`);
            }
        }

        async function publishCollection(id) {
            const token = getTokenOrAlert();
            if (!token) return;
            
            // ä¹è§‚æ›´æ–°ï¼šå…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
            const col = collections.find(c => c.id === id);
            if (col) {
                col.isPublished = true;
                renderCollections(); // ç«‹å³æ›´æ–°UI
            }
            
            try {
                const res = await fetch(`${COLLECTION_API_BASE}/${id}/publish`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                
                if (res.ok && result.success) {
                    showToast('ä¸Šçº¿æˆåŠŸ', 'success');
                } else {
                    throw new Error(result.message || 'ä¸Šçº¿å¤±è´¥');
                }
            } catch (e) {
                // å¤±è´¥æ—¶å›æ»šçŠ¶æ€
                if (col) {
                    col.isPublished = false;
                    renderCollections();
                }
                showToast('ä¸Šçº¿å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function unpublishCollection(id) {
            const token = getTokenOrAlert();
            if (!token) return;
            
            // ä¹è§‚æ›´æ–°ï¼šå…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€
            const col = collections.find(c => c.id === id);
            if (col) {
                col.isPublished = false;
                renderCollections(); // ç«‹å³æ›´æ–°UI
            }
            
            try {
                const res = await fetch(`${COLLECTION_API_BASE}/${id}/unpublish`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                
                if (res.ok && result.success) {
                    showToast('ä¸‹çº¿æˆåŠŸ', 'success');
                } else {
                    throw new Error(result.message || 'ä¸‹çº¿å¤±è´¥');
                }
            } catch (e) {
                // å¤±è´¥æ—¶å›æ»šçŠ¶æ€
                if (col) {
                    col.isPublished = true;
                    renderCollections();
                }
                showToast('ä¸‹çº¿å¤±è´¥: ' + e.message, 'error');
            }
        }

        function startEditCollection(id) {
            const col = collections.find(c => c.id === id);
            if (!col) {
                alert('åˆé›†ä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°åˆ—è¡¨');
                return;
            }
            if (col.isPublished) {
                alert('å·²ä¸Šçº¿åˆé›†ä¸å¯ç¼–è¾‘ï¼Œè¯·å…ˆä¸‹çº¿');
                return;
            }
            
            editingCollectionId = id;
            
            // æ˜¾ç¤ºç¼–è¾‘æ¨¡å¼UI
            document.getElementById('collectionFormHeader').style.display = 'block';
            document.getElementById('editModeTitle').textContent = `ç¼–è¾‘åˆé›†: ${col.name}`;
            document.getElementById('saveCollectionBtn').textContent = 'ä¿å­˜ä¿®æ”¹';
            showCollectionForm(true);
            showCollectionsList(false);
            // éšè—é¡¶éƒ¨ tab æ å’Œåˆ›å»ºæŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼åŒæ ·éœ€è¦ï¼‰
            document.querySelector('.nav-tabs').style.display = 'none';
            document.querySelector('.collections-actions').style.display = 'none';
            
            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('colName').value = col.name || '';
            document.getElementById('colDesc').value = col.description || '';
            
            // è®¾ç½®å°é¢å›¾
            if (col.coverImage) {
                document.getElementById('colCover').value = col.coverImage;
                const preview = document.getElementById('coverPreview');
                const imgEl = document.getElementById('coverPreviewImg');
                imgEl.src = col.coverImage;
                preview.style.display = 'flex';
                document.getElementById('coverPreviewInfo').textContent = 'å·²è®¾ç½®å°é¢å›¾';
            } else {
                clearCoverFile();
            }
            
            // è®¾ç½®åœ°ç‚¹
            selectedSpots = (col.collectionSpots || []).map(cs => ({
                id: cs.spotId,
                name: cs.spot?.name || cs.spotId,
                city: cs.spot?.city,
                address: cs.spot?.address,
            }));
            renderSelectedSpots();

            // è®¾ç½®äººç‰© - API è¿”å›çš„å·²ç»æ˜¯æ•°ç»„ï¼Œä¸éœ€è¦ JSON.parse
            if (Array.isArray(col.people)) {
                peopleListData = col.people;
            } else if (typeof col.people === 'string' && col.people) {
                try {
                    peopleListData = JSON.parse(col.people);
                } catch { 
                    peopleListData = []; 
                }
            } else {
                peopleListData = [];
            }
            renderPeople();
            
            // è®¾ç½®ä½œå“ - API è¿”å›çš„å·²ç»æ˜¯æ•°ç»„ï¼Œä¸éœ€è¦ JSON.parse
            if (Array.isArray(col.works)) {
                worksListData = col.works;
            } else if (typeof col.works === 'string' && col.works) {
                try {
                    worksListData = JSON.parse(col.works);
                } catch { 
                    worksListData = []; 
                }
            } else {
                worksListData = [];
            }
            renderWorks();
            
            // åˆ‡æ¢åˆ°åˆé›†ç®¡ç†é¡µé¢ï¼Œå¹¶éšè—åˆ—è¡¨
            showSection('collections');
            hideCollectionsList();
            
            // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºæ£€æµ‹æ˜¯å¦æœ‰ä¿®æ”¹
            originalCollectionData = {
                name: col.name || '',
                description: col.description || '',
                coverImage: col.coverImage || '',
                spotIds: selectedSpots.map(s => s.id).sort().join(','),
                people: JSON.stringify(peopleListData),
                works: JSON.stringify(worksListData)
            };
            
            // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
            document.getElementById('collectionsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function cancelEdit() {
            // æ£€æµ‹æ˜¯å¦æœ‰ä¿®æ”¹
            const hasChanges = checkCollectionFormChanges();
            if (hasChanges) {
                if (confirm('ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                    backToCollectionsList();
                }
            } else {
                // æ²¡æœ‰ä¿®æ”¹ï¼Œç›´æ¥è¿”å›
                backToCollectionsList();
            }
        }
        
        // æ£€æµ‹åˆé›†è¡¨å•æ˜¯å¦æœ‰ä¿®æ”¹
        function checkCollectionFormChanges() {
            if (!originalCollectionData) return false;
            
            const currentData = {
                name: document.getElementById('colName').value || '',
                description: document.getElementById('colDesc').value || '',
                coverImage: document.getElementById('colCover').value || '',
                spotIds: selectedSpots.map(s => s.id).sort().join(','),
                people: JSON.stringify(peopleListData),
                works: JSON.stringify(worksListData)
            };
            
            return currentData.name !== originalCollectionData.name ||
                   currentData.description !== originalCollectionData.description ||
                   currentData.coverImage !== originalCollectionData.coverImage ||
                   currentData.spotIds !== originalCollectionData.spotIds ||
                   currentData.people !== originalCollectionData.people ||
                   currentData.works !== originalCollectionData.works;
        }
        
        // è¿”å›åˆé›†åº“åˆ—è¡¨é¡µï¼Œæ¢å¤ tab æ å’Œåˆ—è¡¨æ˜¾ç¤º
        function backToCollectionsList() {
            editingCollectionId = null;
            originalCollectionData = null; // æ¸…ç©ºåŸå§‹æ•°æ®
            // æ¢å¤é¡¶éƒ¨ tab æ å’Œåˆ›å»ºæŒ‰é’®
            document.querySelector('.nav-tabs').style.display = 'flex';
            document.querySelector('.collections-actions').style.display = 'flex';
            // éšè—è¡¨å•ï¼Œæ˜¾ç¤ºåˆ—è¡¨
            showCollectionForm(false);
            showCollectionsList(true);
            // æ¸…ç©ºè¡¨å•
            document.getElementById('colName').value = '';
            document.getElementById('colDesc').value = '';
            clearCoverFile();
            selectedSpots = [];
            renderSelectedSpots();
            peopleListData = [];
            worksListData = [];
            renderPeople();
            renderWorks();
            document.getElementById('collectionFormHeader').style.display = 'none';
            document.getElementById('saveCollectionBtn').textContent = 'åˆ›å»ºåˆé›†';
        }
        
        function hideCollectionsList() {
            const listContainer = document.getElementById('collectionsListContainer');
            if (listContainer) {
                listContainer.style.display = 'none';
            }
        }

        // åœ°ç‚¹æœç´¢/é€‰æ‹© - ä»å…¬å…±åœ°ç‚¹åº“æœç´¢ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…
        function handleSpotSearch(value) {
            const query = value.trim();
            const dropdown = document.getElementById('spotSearchDropdown');
            if (spotSearchTimer) clearTimeout(spotSearchTimer);
            if (query.length < 1) {
                dropdown.style.display = 'none';
                dropdown.innerHTML = '';
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            dropdown.style.display = 'block';
            dropdown.innerHTML = '<div style="padding:12px;color:#666;">æœç´¢ä¸­...</div>';
            
            spotSearchTimer = setTimeout(async () => {
                try {
                    // ä½¿ç”¨å…¬å…±åœ°ç‚¹åº“APIï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢
                    const res = await fetch(`${API_BASE}?search=${encodeURIComponent(query)}&limit=50`);
                    const data = await res.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        // æ¨¡ç³ŠåŒ¹é…ï¼šåç§°æˆ–åœ°å€åŒ…å«æŸ¥è¯¢å­—ç¬¦ä¸²
                        const queryLower = query.toLowerCase();
                        const filtered = data.data.filter((s) => {
                            const name = (s.name || '').toLowerCase();
                            const address = (s.address || '').toLowerCase();
                            const city = (s.city || '').toLowerCase();
                            return name.includes(queryLower) || address.includes(queryLower) || city.includes(queryLower);
                        });
                        
                        if (filtered.length > 0) {
                            renderSpotDropdown(filtered, query);
                        } else {
                            dropdown.innerHTML = '<div style="padding:12px;color:#999;">æœªæ‰¾åˆ°åŒ¹é…çš„åœ°ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
                        }
                    } else {
                        dropdown.innerHTML = '<div style="padding:12px;color:#999;">æœªæ‰¾åˆ°åœ°ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
                    }
                } catch (e) {
                    console.error('æœç´¢åœ°ç‚¹å¤±è´¥', e);
                    dropdown.innerHTML = '<div style="padding:12px;color:#f00;">æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
            }, 300);
        }

        async function searchByLatLng() {
            const lat = parseFloat(document.getElementById('spotLat').value);
            const lng = parseFloat(document.getElementById('spotLng').value);
            if (Number.isNaN(lat) || Number.isNaN(lng)) {
                return alert('è¯·è¾“å…¥ç»çº¬åº¦');
            }
            const dropdown = document.getElementById('spotSearchDropdown');
            try {
                // ä½¿ç”¨å…¬å…±åœ°ç‚¹åº“APIï¼Œé€šè¿‡ç»çº¬åº¦æœç´¢
                const res = await fetch(`${API_BASE}?lat=${lat}&lng=${lng}&radius=5000&limit=20`);
                const data = await res.json();
                if (data.success && data.data) {
                    renderSpotDropdown(data.data, '');
                } else {
                    dropdown.style.display = 'none';
                }
            } catch (e) {
                console.error('ç»çº¬åº¦æœç´¢å¤±è´¥', e);
                dropdown.style.display = 'none';
            }
        }

        function renderSpotDropdown(list, query) {
            const dropdown = document.getElementById('spotSearchDropdown');
            if (!list || list.length === 0) {
                dropdown.style.display = 'none';
                dropdown.innerHTML = '';
                return;
            }
            dropdown.style.display = 'block';
            dropdown.innerHTML = '';
            list.forEach((s) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-id', s.id || '');
                item.setAttribute('data-name', s.name || '');
                item.setAttribute('data-city', s.city || '');
                item.setAttribute('data-address', s.address || '');
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <div><strong>${s.name || ''}</strong></div>
                    <div style="color:#666;font-size:12px;">${s.city || ''} ${s.address || ''}</div>
                `;
                item.addEventListener('click', () => {
                    addSpot(s.id || '', s.name || '', s.city || '', s.address || '');
                });
                dropdown.appendChild(item);
            });
        }

        async function addSpot(publicPlaceId, name, city, address) {
            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ ï¼ˆé€šè¿‡åç§°å’ŒåŸå¸‚åˆ¤æ–­ï¼Œå› ä¸ºIDå¯èƒ½ä¼šå˜åŒ–ï¼‰
            if (selectedSpots.some(s => s.name === name && s.city === city)) {
                alert('è¯¥åœ°ç‚¹å·²æ·»åŠ ');
                document.getElementById('spotSearchDropdown').style.display = 'none';
                document.getElementById('spotSearchInput').value = '';
                return;
            }
            
            // å°†publicPlace IDè½¬æ¢ä¸ºspot ID
            try {
                const res = await fetch(`${SPOT_API_BASE}/from-public-place`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ publicPlaceId }),
                });
                
                const result = await res.json();
                
                // API è¿”å› place æˆ– spot
                const placeData = result.place || result.spot;
                
                if (result.success && placeData) {
                    // ä½¿ç”¨ place ID
                    selectedSpots.push({ 
                        id: placeData.id, 
                        name: placeData.name || name, 
                        city: placeData.city || city, 
                        address: placeData.address || address 
                    });
                    renderSelectedSpots();
                    document.getElementById('spotSearchDropdown').style.display = 'none';
                    document.getElementById('spotSearchInput').value = '';
                } else {
                    throw new Error(result.message || 'è½¬æ¢å¤±è´¥');
                }
            } catch (error) {
                console.error('è½¬æ¢spot IDå¤±è´¥:', error);
                alert(`æ·»åŠ åœ°ç‚¹å¤±è´¥: ${error.message || 'è¯·é‡è¯•'}`);
            }
        }

        function removeSpot(id) {
            selectedSpots = selectedSpots.filter(s => s.id !== id);
            renderSelectedSpots();
        }

        function renderSelectedSpots() {
            const container = document.getElementById('selectedSpots');
            container.innerHTML = '';
            selectedSpots.forEach((s, index) => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.innerHTML = `
                    <span>${s.name || ''}</span>
                    <span style="color:#777;font-size:12px;">${s.city || ''}</span>
                    <button>Ã—</button>
                `;
                chip.querySelector('button').addEventListener('click', () => {
                    removeSpot(s.id);
                });
                container.appendChild(chip);
            });
        }

        // äººç‰©ä¸ä½œå“
        function renderPeople() {
            const container = document.getElementById('peopleList');
            container.innerHTML = peopleListData.map((p, idx) => `
                <div class="form-card" style="margin:8px 0;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å§“å</label>
                            <input type="text" value="${p.name || ''}" oninput="updatePerson(${idx}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>é“¾æ¥</label>
                            <input type="text" value="${p.link || ''}" oninput="updatePerson(${idx}, 'link', this.value)">
                        </div>
                        <div class="form-group">
                            <label>å¤´åƒä¸Šä¼ ï¼ˆâ‰¤5MBï¼‰</label>
                            <input type="file" accept="image/*" onchange="handlePersonAvatar(${idx}, this.files)">
                            ${p.avatarUrl ? `<div class="upload-preview" style="display:flex;"><img src="${p.avatarUrl}" alt="avatar"></div>` : ''}
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" type="button" onclick="removePerson(${idx})">åˆ é™¤äººç‰©</button>
                    </div>
                </div>
            `).join('');
        }

        function renderWorks() {
            const container = document.getElementById('worksList');
            container.innerHTML = worksListData.map((w, idx) => `
                <div class="form-card" style="margin:8px 0;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>ä½œå“å</label>
                            <input type="text" value="${w.name || ''}" oninput="updateWork(${idx}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>é“¾æ¥</label>
                            <input type="text" value="${w.link || ''}" oninput="updateWork(${idx}, 'link', this.value)">
                        </div>
                        <div class="form-group">
                            <label>å°é¢ä¸Šä¼ ï¼ˆâ‰¤5MBï¼‰</label>
                            <input type="file" accept="image/*" onchange="handleWorkCover(${idx}, this.files)">
                            ${w.coverImage ? `<div class="upload-preview" style="display:flex;"><img src="${w.coverImage}" alt="work"></div>` : ''}
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" type="button" onclick="removeWork(${idx})">åˆ é™¤ä½œå“</button>
                    </div>
                </div>
            `).join('');
        }

        function addPerson() {
            peopleListData.push({ name: '', avatarUrl: '', link: '' });
            renderPeople();
        }

        function addWork() {
            worksListData.push({ name: '', coverImage: '', link: '' });
            renderWorks();
        }

        function removePerson(idx) {
            peopleListData.splice(idx, 1);
            renderPeople();
        }

        function removeWork(idx) {
            worksListData.splice(idx, 1);
            renderWorks();
        }

        function updatePerson(idx, key, value) {
            peopleListData[idx][key] = value;
        }

        function updateWork(idx, key, value) {
            worksListData[idx][key] = value;
        }

        async function handlePersonAvatar(idx, files) {
            if (!files || files.length === 0) return;
            const file = files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡è¶…è¿‡ 5MBï¼Œæ— æ³•é€‰æ‹©');
                return;
            }
            try {
                const compressedDataUrl = await compressImage(file, 800, 800, 0.8);
                peopleListData[idx].avatarUrl = compressedDataUrl;
                renderPeople();
            } catch (error) {
                console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error);
                alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function handleWorkCover(idx, files) {
            if (!files || files.length === 0) return;
            const file = files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡è¶…è¿‡ 5MBï¼Œæ— æ³•é€‰æ‹©');
                return;
            }
            try {
                const compressedDataUrl = await compressImage(file, 800, 800, 0.8);
                worksListData[idx].coverImage = compressedDataUrl;
                renderWorks();
            } catch (error) {
                console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error);
                alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å‹ç¼©å›¾ç‰‡
        function compressImage(file, maxWidth = 1200, maxHeight = 1600, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // è®¡ç®—æ–°å°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width = width * ratio;
                            height = height * ratio;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // è½¬æ¢ä¸ºDataURLï¼Œä½¿ç”¨JPEGæ ¼å¼å‹ç¼©
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleCoverFile(files) {
            if (!files || files.length === 0) return;
            const file = files[0];

            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert('å›¾ç‰‡è¶…è¿‡ 5MBï¼Œæ— æ³•é€‰æ‹©');
                clearCoverFile();
                return;
            }

            try {
                // å‹ç¼©å›¾ç‰‡
                const compressedDataUrl = await compressImage(file, 1200, 1600, 0.8);
                
                const img = new Image();
                img.onload = () => {
                    const { width, height } = img;
                    const ratio = width / height; // portrait expected ~ 3/4 = 0.75
                    const isPortrait43 = ratio >= 0.7 && ratio <= 0.8;
                    if (!isPortrait43) {
                        alert('è¯·ä½¿ç”¨ç«–å‘ 4:3 å›¾ç‰‡ï¼ˆå®½é«˜æ¯”çº¦ 3:4ï¼‰');
                        clearCoverFile();
                        return;
                    }

                    // é€šè¿‡æ ¡éªŒï¼Œè®¾ç½®é¢„è§ˆå’Œè¾“å…¥å€¼
                    document.getElementById('colCover').value = compressedDataUrl;
                    const preview = document.getElementById('coverPreview');
                    const imgEl = document.getElementById('coverPreviewImg');
                    const infoEl = document.getElementById('coverPreviewInfo');
                    imgEl.src = compressedDataUrl;
                    preview.style.display = 'flex';
                    const compressedSize = (compressedDataUrl.length * 3 / 4 / 1024 / 1024).toFixed(2);
                    infoEl.textContent = `å°ºå¯¸: ${width}x${height}, å‹ç¼©åå¤§å°: ${compressedSize}MB`;
                };
                img.onerror = () => {
                    alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                    clearCoverFile();
                };
                img.src = compressedDataUrl;
            } catch (error) {
                console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error);
                alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
                clearCoverFile();
            }
        }

        function clearCoverFile() {
            document.getElementById('colCoverFile').value = '';
            document.getElementById('colCover').value = '';
            document.getElementById('coverPreview').style.display = 'none';
        }

        // ============ åœ°ç‚¹ç¼–è¾‘/æ–°å¢åŠŸèƒ½ ============
        let currentEditPlace = null;
        let placeImages = []; // å­˜å‚¨å½“å‰åœ°ç‚¹çš„å›¾ç‰‡åˆ—è¡¨
        
        // æ‰“å¼€æ–°å¢åœ°ç‚¹å¼¹çª—
        function openAddPlaceModal() {
            currentEditPlace = null;
            placeImages = [];
            document.getElementById('placeModalTitle').textContent = 'æ–°å¢åœ°ç‚¹';
            document.getElementById('editPlaceId').value = '';
            clearPlaceForm();
            document.getElementById('placeModal').style.display = 'flex';
        }
        
        // æ‰“å¼€ç¼–è¾‘åœ°ç‚¹å¼¹çª—
        async function openEditPlaceModal(id) {
            try {
                // å§‹ç»ˆä» API è·å–æœ€æ–°æ•°æ®ï¼Œç¡®ä¿ç¼–è¾‘æ—¶æ˜¾ç¤ºæœ€æ–°å†…å®¹ï¼ˆåŒ…å«å†…éƒ¨æ ‡ç­¾ï¼‰
                const res = await fetch(`${API_BASE}/${id}?includeInternalTags=true`);
                const result = await res.json();
                if (!result.success || !result.data) {
                    throw new Error('è·å–åœ°ç‚¹æ•°æ®å¤±è´¥');
                }
                const place = result.data;
                
                currentEditPlace = place;
                document.getElementById('placeModalTitle').textContent = 'ç¼–è¾‘åœ°ç‚¹';
                document.getElementById('editPlaceId').value = id;
                
                // å¡«å……è¡¨å•
                document.getElementById('placeName').value = place.name || '';
                // ä½¿ç”¨ categorySlug æ¥è®¾ç½®ä¸‹æ‹‰é€‰é¡¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•ç”¨ category
                document.getElementById('placeCategory').value = place.categorySlug || place.category || '';
                document.getElementById('placeCity').value = place.city || '';
                document.getElementById('placeCountry').value = place.country || '';
                document.getElementById('placeLat').value = place.latitude || '';
                document.getElementById('placeLng').value = place.longitude || '';
                document.getElementById('placeAddress').value = place.address || '';
                document.getElementById('placeDescription').value = place.description || place.aiSummary || '';
                document.getElementById('placeRating').value = place.rating || '';
                document.getElementById('placeRatingCount').value = place.ratingCount || '';
                document.getElementById('placePriceLevel').value = place.priceLevel ?? '';
                document.getElementById('placeWebsite').value = place.website || '';
                document.getElementById('placePhone').value = place.phoneNumber || '';
                document.getElementById('placeCoverImage').value = place.coverImage || '';
                
                // è§£æè¥ä¸šæ—¶é—´
                let openingHoursText = '';
                if (place.openingHours) {
                    try {
                        const hours = typeof place.openingHours === 'string' ? JSON.parse(place.openingHours) : place.openingHours;
                        if (hours && hours.weekday_text && Array.isArray(hours.weekday_text)) {
                            // Format: { weekday_text: ["Monday: 9:00 AM â€“ 5:00 PM", ...] }
                            openingHoursText = hours.weekday_text.join('\n');
                        } else if (Array.isArray(hours)) {
                            // Check if it's Apify format: [{ day: "Monday", hours: "9:00 AM â€“ 5:00 PM" }, ...]
                            if (hours.length > 0 && typeof hours[0] === 'object' && hours[0].day && hours[0].hours) {
                                openingHoursText = hours.map(h => `${h.day}: ${h.hours}`).join('\n');
                            } else {
                                // Simple array of strings: ["Monday: 9:00 AM â€“ 5:00 PM", ...]
                                openingHoursText = hours.join('\n');
                            }
                        }
                    } catch {}
                }
                document.getElementById('placeOpeningHours').value = openingHoursText;
                
                // è§£ææ ‡ç­¾ - tags (ç»“æ„åŒ–æ ‡ç­¾)
                let tags = {};
                if (place.tags && typeof place.tags === 'object' && Object.keys(place.tags).length > 0) {
                    tags = place.tags;
                }
                document.getElementById('placeTagsJson').value = Object.keys(tags).length > 0 ? JSON.stringify(tags, null, 2) : '';
                renderPlaceTags(tags);
                
                // è§£æ aiTags (AI å±•ç¤ºæ ‡ç­¾)
                let aiTags = [];
                if (place.aiTags && Array.isArray(place.aiTags) && place.aiTags.length > 0) {
                    aiTags = place.aiTags;
                }
                document.getElementById('placeAiTagsJson').value = aiTags.length > 0 ? JSON.stringify(aiTags, null, 2) : '';
                renderPlaceAiTags(aiTags);
                
                // è§£æå›¾ç‰‡åˆ—è¡¨
                placeImages = [];
                if (place.coverImage) {
                    placeImages.push(place.coverImage);
                }
                if (place.images) {
                    try {
                        const imgs = typeof place.images === 'string' ? JSON.parse(place.images) : place.images;
                        if (Array.isArray(imgs)) {
                            imgs.forEach(img => {
                                if (!placeImages.includes(img)) {
                                    placeImages.push(img);
                                }
                            });
                        }
                    } catch {}
                }
                
                renderPlaceImages();
                updateCoverImagePreview();
                
                // è§£æå‰§ç…§
                placeStills = [];
                if (place.customFields) {
                    try {
                        const custom = typeof place.customFields === 'string' ? JSON.parse(place.customFields) : place.customFields;
                        if (custom && custom.stills && Array.isArray(custom.stills)) {
                            placeStills = custom.stills;
                        }
                    } catch {}
                }
                renderPlaceStills();
                
                document.getElementById('placeModal').style.display = 'flex';
            } catch (e) {
                console.error('åŠ è½½åœ°ç‚¹æ•°æ®å¤±è´¥:', e);
                alert('åŠ è½½åœ°ç‚¹æ•°æ®å¤±è´¥: ' + e.message);
            }
        }
        
        // å…³é—­åœ°ç‚¹å¼¹çª—
        function closePlaceModal() {
            document.getElementById('placeModal').style.display = 'none';
            currentEditPlace = null;
            placeImages = [];
            placeStills = [];
        }
        
        // æ ‡ç­¾è‡ªåŠ¨å½’ç±»è§„åˆ™
        const TAG_CATEGORIES = {
            meal: ['breakfast', 'brunch', 'lunch', 'dinner', 'supper', 'tea', 'coffee', 'dessert', 'snack'],
            style: ['cozy', 'romantic', 'trendy', 'upscale', 'casual', 'modern', 'traditional', 'elegant', 'rustic', 'minimalist', 'vintage', 'industrial', 'bohemian'],
            theme: ['musician', 'artist', 'writer', 'poet', 'composer', 'painter', 'sculptor', 'philosopher', 'scientist', 'architect', 'filmmaker', 'photographer', 'designer', 'celebrity', 'historical', 'literary', 'musical', 'artistic'],
            award: ['michelin', 'star', 'bib gourmand', 'award', 'prize', 'best', 'top', 'recommended'],
            cuisine: ['italian', 'french', 'japanese', 'chinese', 'korean', 'thai', 'vietnamese', 'indian', 'mexican', 'spanish', 'greek', 'turkish', 'middle eastern', 'american', 'british', 'german', 'mediterranean', 'asian', 'european', 'fusion', 'seafood', 'vegetarian', 'vegan']
        };
        
        // è‡ªåŠ¨å½’ç±»æ ‡ç­¾
        function classifyTag(value) {
            const lowerValue = value.toLowerCase();
            for (const [category, keywords] of Object.entries(TAG_CATEGORIES)) {
                if (keywords.some(kw => lowerValue.includes(kw) || kw.includes(lowerValue))) {
                    return category;
                }
            }
            return 'others';
        }
        
        // å¤„ç†æ ‡ç­¾è¾“å…¥å›è½¦
        function handleTagInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('tagInput');
                const value = input.value.trim();
                if (value) {
                    const type = classifyTag(value);
                    addTagToStore(type, value);
                    input.value = '';
                }
            }
        }
        
        // å¤„ç† AI æ ‡ç­¾è¾“å…¥å›è½¦
        function handleAiTagInputKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('aiTagInput');
                const value = input.value.trim();
                if (value) {
                    addAiTagToStore(value);
                    input.value = '';
                }
            }
        }
        
        // æ·»åŠ æ ‡ç­¾åˆ°å­˜å‚¨
        function addTagToStore(type, value) {
            const hiddenInput = document.getElementById('placeTagsJson');
            let tags = {};
            
            if (hiddenInput.value.trim()) {
                try {
                    tags = JSON.parse(hiddenInput.value);
                } catch (e) {
                    tags = {};
                }
            }
            
            if (!tags[type]) {
                tags[type] = [];
            }
            if (!tags[type].includes(value)) {
                tags[type].push(value);
            }
            
            hiddenInput.value = JSON.stringify(tags, null, 2);
            renderPlaceTags(tags);
        }
        
        // æ·»åŠ  AI æ ‡ç­¾åˆ°å­˜å‚¨
        function addAiTagToStore(value) {
            const hiddenInput = document.getElementById('placeAiTagsJson');
            let aiTags = [];
            
            if (hiddenInput.value.trim()) {
                try {
                    aiTags = JSON.parse(hiddenInput.value);
                } catch (e) {
                    aiTags = [];
                }
            }
            
            if (!Array.isArray(aiTags)) {
                aiTags = [];
            }
            
            // aiTags å¯èƒ½æ˜¯å­—ç¬¦ä¸²æ•°ç»„æˆ–å¯¹è±¡æ•°ç»„ï¼Œç»Ÿä¸€å¤„ç†
            const existingValues = aiTags.map(t => typeof t === 'string' ? t : (t.en || t.id || ''));
            if (!existingValues.includes(value)) {
                aiTags.push(value);
            }
            
            hiddenInput.value = JSON.stringify(aiTags, null, 2);
            renderPlaceAiTags(aiTags);
        }
        
        // æ¸²æŸ“ç»“æ„åŒ–æ ‡ç­¾ä¸º chipsï¼ˆåœ¨è¾“å…¥æ¡†å†…ï¼‰
        function renderPlaceTags(tags) {
            const container = document.getElementById('placeTagsChips');
            if (!tags || typeof tags !== 'object' || Object.keys(tags).length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const typeColors = {
                meal: '#e3f2fd',
                style: '#f3e5f5',
                theme: '#e8f5e9',
                award: '#fff3e0',
                cuisine: '#fce4ec',
                others: '#f5f5f5'
            };
            
            const chips = [];
            for (const [type, values] of Object.entries(tags)) {
                if (Array.isArray(values)) {
                    const bgColor = typeColors[type] || typeColors.others;
                    values.forEach(value => {
                        chips.push(`
                            <span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:${bgColor};border-radius:12px;font-size:12px;white-space:nowrap;">
                                <span style="color:#666;font-size:10px;">${type}:</span>
                                <span style="font-weight:500;">${value}</span>
                                <button type="button" onclick="removeTag('${type}', '${value}')" style="border:none;background:none;cursor:pointer;color:#999;font-size:14px;line-height:1;padding:0 2px;" title="åˆ é™¤">Ã—</button>
                            </span>
                        `);
                    });
                }
            }
            
            container.innerHTML = chips.join('');
        }
        
        // æ¸²æŸ“ AI æ ‡ç­¾ä¸º chipsï¼ˆåœ¨è¾“å…¥æ¡†å†…ï¼‰
        function renderPlaceAiTags(aiTags) {
            const container = document.getElementById('placeAiTagsChips');
            if (!aiTags || !Array.isArray(aiTags) || aiTags.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            const chips = aiTags.map((tag, idx) => {
                // æ”¯æŒå­—ç¬¦ä¸²æˆ–å¯¹è±¡æ ¼å¼
                const displayText = typeof tag === 'string' ? tag : (tag.en || tag.id || JSON.stringify(tag));
                return `
                    <span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:#fff3cd;border-radius:12px;font-size:12px;white-space:nowrap;">
                        <span style="font-weight:500;color:#856404;">${displayText}</span>
                        <button type="button" onclick="removeAiTag(${idx})" style="border:none;background:none;cursor:pointer;color:#856404;font-size:14px;line-height:1;padding:0 2px;" title="åˆ é™¤">Ã—</button>
                    </span>
                `;
            }).join('');
            
            container.innerHTML = chips;
        }
        
        // åˆ é™¤ç»“æ„åŒ–æ ‡ç­¾
        function removeTag(type, value) {
            const hiddenInput = document.getElementById('placeTagsJson');
            let tags = {};
            
            if (hiddenInput.value.trim()) {
                try {
                    tags = JSON.parse(hiddenInput.value);
                } catch (e) {
                    return;
                }
            }
            
            if (tags[type] && Array.isArray(tags[type])) {
                tags[type] = tags[type].filter(v => v !== value);
                if (tags[type].length === 0) {
                    delete tags[type];
                }
            }
            
            hiddenInput.value = Object.keys(tags).length > 0 ? JSON.stringify(tags, null, 2) : '';
            renderPlaceTags(tags);
        }
        
        // åˆ é™¤ AI æ ‡ç­¾
        function removeAiTag(index) {
            const hiddenInput = document.getElementById('placeAiTagsJson');
            let aiTags = [];
            
            if (hiddenInput.value.trim()) {
                try {
                    aiTags = JSON.parse(hiddenInput.value);
                } catch (e) {
                    return;
                }
            }
            
            if (Array.isArray(aiTags) && index >= 0 && index < aiTags.length) {
                aiTags.splice(index, 1);
            }
            
            hiddenInput.value = aiTags.length > 0 ? JSON.stringify(aiTags, null, 2) : '';
            renderPlaceAiTags(aiTags);
        }
        
        // æ¸…ç©ºåœ°ç‚¹è¡¨å•
        function clearPlaceForm() {
            document.getElementById('placeName').value = '';
            document.getElementById('placeCategory').value = '';
            document.getElementById('placeCity').value = '';
            document.getElementById('placeCountry').value = '';
            document.getElementById('placeLat').value = '';
            document.getElementById('placeLng').value = '';
            document.getElementById('placeAddress').value = '';
            document.getElementById('placeDescription').value = '';
            document.getElementById('placeRating').value = '';
            document.getElementById('placeRatingCount').value = '';
            document.getElementById('placePriceLevel').value = '';
            document.getElementById('placeWebsite').value = '';
            document.getElementById('placePhone').value = '';
            document.getElementById('placeOpeningHours').value = '';
            document.getElementById('placeTagsJson').value = '';
            document.getElementById('placeAiTagsJson').value = '';
            document.getElementById('placeCoverImage').value = '';
            document.getElementById('placeImageUpload').value = '';
            document.getElementById('tagInput').value = '';
            document.getElementById('aiTagInput').value = '';
            // æ¸…ç©ºæ ‡ç­¾ chips
            renderPlaceTags({});
            renderPlaceAiTags([]);
            placeImages = [];
            renderPlaceImages();
            updateCoverImagePreview();
            // æ¸…ç©ºå‰§ç…§
            placeStills = [];
            renderPlaceStills();
            const stillUpload = document.getElementById('placeStillUpload');
            if (stillUpload) stillUpload.value = '';
        }
        
        // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨
        function renderPlaceImages() {
            const container = document.getElementById('placeImagesList');
            const coverImage = document.getElementById('placeCoverImage').value;
            
            container.innerHTML = placeImages.map((img, idx) => {
                const isCover = img === coverImage;
                return `
                    <div class="chip" style="padding:4px;${isCover ? 'border:2px solid #667eea;' : ''}">
                        <img src="${img}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;cursor:pointer;" 
                             onclick="setAsCoverImage(${idx})" title="ç‚¹å‡»è®¾ä¸ºå°é¢" 
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><rect fill=%22%23ddd%22 width=%22100%25%22 height=%22100%25%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>ğŸ“·</text></svg>'">
                        ${isCover ? '<span style="font-size:10px;color:#667eea;">å°é¢</span>' : ''}
                        <button onclick="removePlaceImage(${idx})" style="margin-left:4px;">Ã—</button>
                    </div>
                `;
            }).join('');
        }
        
        // è®¾ç½®å°é¢å›¾
        function setAsCoverImage(idx) {
            if (placeImages[idx]) {
                document.getElementById('placeCoverImage').value = placeImages[idx];
                renderPlaceImages();
                updateCoverImagePreview();
            }
        }
        
        // åˆ é™¤å›¾ç‰‡
        function removePlaceImage(idx) {
            const removedImg = placeImages[idx];
            placeImages.splice(idx, 1);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å°é¢å›¾ï¼Œæ¸…ç©ºå°é¢æˆ–è®¾ç½®ç¬¬ä¸€å¼ ä¸ºå°é¢
            const coverImage = document.getElementById('placeCoverImage').value;
            if (removedImg === coverImage) {
                document.getElementById('placeCoverImage').value = placeImages[0] || '';
                updateCoverImagePreview();
            }
            
            renderPlaceImages();
        }
        
        // æ›´æ–°å°é¢å›¾é¢„è§ˆ
        function updateCoverImagePreview() {
            const coverImage = document.getElementById('placeCoverImage').value;
            const preview = document.getElementById('coverImagePreview');
            if (coverImage) {
                preview.innerHTML = `<img src="${coverImage}" style="width:120px;height:90px;object-fit:cover;border-radius:6px;border:1px solid #ddd;" onerror="this.style.display='none'">`;
            } else {
                preview.innerHTML = '';
            }
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        async function handlePlaceImageUpload(files) {
            if (!files || files.length === 0) return;
            const file = files[0];
            
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡è¶…è¿‡ 5MB');
                return;
            }
            
            try {
                const compressedDataUrl = await compressImage(file, 1200, 1200, 0.8);
                placeImages.push(compressedDataUrl);
                
                // å¦‚æœæ²¡æœ‰å°é¢å›¾ï¼Œè‡ªåŠ¨è®¾ç½®ç¬¬ä¸€å¼ ä¸ºå°é¢
                if (!document.getElementById('placeCoverImage').value) {
                    document.getElementById('placeCoverImage').value = compressedDataUrl;
                    updateCoverImagePreview();
                }
                
                renderPlaceImages();
                document.getElementById('placeImageUpload').value = '';
            } catch (e) {
                console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', e);
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
            }
        }
        
        // ============ å‰§ç…§ç®¡ç† ============
        let placeStills = []; // å­˜å‚¨å‰§ç…§åˆ—è¡¨
        
        // å¤„ç†å‰§ç…§ä¸Šä¼ 
        async function handlePlaceStillUpload(files) {
            if (!files || files.length === 0) return;
            const file = files[0];
            
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡è¶…è¿‡ 5MB');
                return;
            }
            
            try {
                const compressedDataUrl = await compressImage(file, 1200, 1200, 0.8);
                placeStills.push(compressedDataUrl);
                renderPlaceStills();
                document.getElementById('placeStillUpload').value = '';
            } catch (e) {
                console.error('å‰§ç…§ä¸Šä¼ å¤±è´¥:', e);
                alert('å‰§ç…§ä¸Šä¼ å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“å‰§ç…§åˆ—è¡¨ - æ”¯æŒæŒ‰ç”µå½±åˆ†ç»„æ˜¾ç¤º
        function renderPlaceStills() {
            const container = document.getElementById('placeStillsList');
            if (!container) return;
            
            if (!placeStills || placeStills.length === 0) {
                container.innerHTML = '<div style="color:#999;font-size:13px;">æš‚æ— å‰§ç…§</div>';
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ ¼å¼ï¼ˆå¸¦ç”µå½±ä¿¡æ¯çš„å¯¹è±¡æ•°ç»„ï¼‰
            const hasMovieInfo = placeStills.some(s => typeof s === 'object' && s.movieId);
            
            if (hasMovieInfo) {
                // æŒ‰ç”µå½±åˆ†ç»„
                const movieGroups = {};
                placeStills.forEach((still, idx) => {
                    if (typeof still === 'object' && still.movieId) {
                        const key = still.movieId;
                        if (!movieGroups[key]) {
                            movieGroups[key] = {
                                movieNameCn: still.movieNameCn || '',
                                movieNameEn: still.movieNameEn || '',
                                year: still.year || '',
                                stills: []
                            };
                        }
                        movieGroups[key].stills.push({ url: still.url, idx });
                    } else {
                        // å…¼å®¹æ—§æ ¼å¼ï¼ˆçº¯å­—ç¬¦ä¸²URLï¼‰
                        const key = '_unknown_';
                        if (!movieGroups[key]) {
                            movieGroups[key] = { movieNameCn: 'æœªçŸ¥ç”µå½±', movieNameEn: '', year: '', stills: [] };
                        }
                        movieGroups[key].stills.push({ url: typeof still === 'string' ? still : still.url, idx });
                    }
                });
                
                // æ¸²æŸ“åˆ†ç»„
                let html = '';
                Object.entries(movieGroups).forEach(([movieId, group]) => {
                    const movieTitle = group.movieNameCn 
                        ? `ğŸ¬ ${group.movieNameCn}${group.movieNameEn ? ' / ' + group.movieNameEn : ''}${group.year ? ' (' + group.year + ')' : ''}`
                        : (group.movieNameEn || 'æœªçŸ¥ç”µå½±');
                    
                    html += `
                        <div style="width:100%;margin-bottom:16px;">
                            <div style="font-weight:600;color:#667eea;margin-bottom:8px;font-size:14px;border-bottom:1px solid #eee;padding-bottom:4px;">
                                ${movieTitle}
                                <span style="color:#999;font-weight:normal;font-size:12px;margin-left:8px;">${group.stills.length} å¼ å‰§ç…§</span>
                            </div>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;">
                                ${group.stills.map(s => `
                                    <div class="chip" style="padding:4px;">
                                        <img src="${s.url}" style="width:100px;height:75px;object-fit:cover;border-radius:4px;" 
                                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%2275%22><rect fill=%22%23ddd%22 width=%22100%25%22 height=%22100%25%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>ğŸ¬</text></svg>'">
                                        <button onclick="removePlaceStill(${s.idx})" style="margin-left:4px;">Ã—</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                // æ—§æ ¼å¼ï¼šç®€å•çš„å›¾ç‰‡URLæ•°ç»„
                container.innerHTML = placeStills.map((img, idx) => {
                    const imgUrl = typeof img === 'string' ? img : (img.url || img);
                    return `
                        <div class="chip" style="padding:4px;">
                            <img src="${imgUrl}" style="width:80px;height:60px;object-fit:cover;border-radius:4px;" 
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2260%22><rect fill=%22%23ddd%22 width=%22100%25%22 height=%22100%25%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22>ğŸ¬</text></svg>'">
                            <button onclick="removePlaceStill(${idx})" style="margin-left:4px;">Ã—</button>
                        </div>
                    `;
                }).join('');
            }
        }
        
        // åˆ é™¤å‰§ç…§
        function removePlaceStill(idx) {
            placeStills.splice(idx, 1);
            renderPlaceStills();
        }
        
        // ä¿å­˜åœ°ç‚¹æ•°æ®
        async function savePlaceData() {
            // æ ¡éªŒå¿…å¡«å­—æ®µ
            const name = document.getElementById('placeName').value.trim();
            const lat = parseFloat(document.getElementById('placeLat').value);
            const lng = parseFloat(document.getElementById('placeLng').value);
            
            if (!name) {
                alert('è¯·è¾“å…¥åœ°ç‚¹åç§°');
                return;
            }
            if (isNaN(lat) || isNaN(lng)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦');
                return;
            }
            
            // æ ¡éªŒè¯„åˆ†èŒƒå›´
            const ratingVal = document.getElementById('placeRating').value;
            if (ratingVal && (parseFloat(ratingVal) < 0 || parseFloat(ratingVal) > 5)) {
                alert('è¯„åˆ†å¿…é¡»åœ¨ 0-5 ä¹‹é—´');
                return;
            }
            
            // æ ¡éªŒä»·æ ¼ç­‰çº§
            const priceLevelVal = document.getElementById('placePriceLevel').value;
            if (priceLevelVal && (parseInt(priceLevelVal) < 0 || parseInt(priceLevelVal) > 4)) {
                alert('ä»·æ ¼ç­‰çº§å¿…é¡»åœ¨ 0-4 ä¹‹é—´');
                return;
            }
            
            // æ ¡éªŒç½‘ç«™URLæ ¼å¼
            const website = document.getElementById('placeWebsite').value.trim();
            if (website && !website.match(/^https?:\/\/.+/)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘ç«™URLï¼ˆä»¥http://æˆ–https://å¼€å¤´ï¼‰');
                return;
            }
            
            try {
                const token = getTokenOrAlert();
                const editId = document.getElementById('editPlaceId').value;
                const isEdit = !!editId;
                
                // è§£æè¥ä¸šæ—¶é—´ - ç›´æ¥ä¿å­˜ä¸ºå­—ç¬¦ä¸²æ•°ç»„
                const openingHoursText = document.getElementById('placeOpeningHours').value.trim();
                let openingHours = null;
                if (openingHoursText) {
                    const lines = openingHoursText.split('\n').filter(l => l.trim());
                    if (lines.length > 0) {
                        openingHours = lines; // ç›´æ¥ä¿å­˜æ•°ç»„ï¼Œä¸å†åµŒå¥—åœ¨ weekday_text é‡Œ
                    }
                }
                
                // è§£ææ ‡ç­¾ - tags (ç»“æ„åŒ–æ ‡ç­¾)
                const tagsJsonText = document.getElementById('placeTagsJson').value.trim();
                let tags = null;
                if (tagsJsonText) {
                    try {
                        tags = JSON.parse(tagsJsonText);
                    } catch (e) {
                        alert('ç»“æ„åŒ–æ ‡ç­¾ JSON æ ¼å¼é”™è¯¯: ' + e.message);
                        return;
                    }
                }
                
                // è§£æ aiTags (AI å±•ç¤ºæ ‡ç­¾)
                const aiTagsJsonText = document.getElementById('placeAiTagsJson').value.trim();
                let aiTags = null;
                if (aiTagsJsonText) {
                    try {
                        aiTags = JSON.parse(aiTagsJsonText);
                        if (!Array.isArray(aiTags)) {
                            alert('AI æ ‡ç­¾å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼');
                            return;
                        }
                    } catch (e) {
                        alert('AI æ ‡ç­¾ JSON æ ¼å¼é”™è¯¯: ' + e.message);
                        return;
                    }
                }
                
                // æ„å»ºè¯·æ±‚æ•°æ®
                const coverImage = document.getElementById('placeCoverImage').value.trim();
                
                // æ„å»º customFieldsï¼ˆåŒ…å«å‰§ç…§ï¼‰
                let customFields = undefined;
                if (placeStills && placeStills.length > 0) {
                    customFields = JSON.stringify({ stills: placeStills });
                }
                
                const payload = {
                    name,
                    latitude: lat,
                    longitude: lng,
                    city: document.getElementById('placeCity').value.trim() || undefined,
                    country: document.getElementById('placeCountry').value.trim() || undefined,
                    address: document.getElementById('placeAddress').value.trim() || undefined,
                    category: document.getElementById('placeCategory').value.trim() || undefined,
                    description: document.getElementById('placeDescription').value.trim() || undefined,
                    rating: ratingVal ? parseFloat(ratingVal) : undefined,
                    ratingCount: document.getElementById('placeRatingCount').value ? parseInt(document.getElementById('placeRatingCount').value) : undefined,
                    priceLevel: priceLevelVal ? parseInt(priceLevelVal) : undefined,
                    website: website || undefined,
                    phoneNumber: document.getElementById('placePhone').value.trim() || undefined,
                    openingHours: openingHours ? JSON.stringify(openingHours) : undefined,
                    tags: tags ? JSON.stringify(tags) : undefined,
                    aiTags: aiTags ? JSON.stringify(aiTags) : undefined,
                    coverImage: coverImage || undefined,
                    images: placeImages.length > 0 ? JSON.stringify(placeImages) : undefined,
                    customFields: customFields,
                    source: isEdit ? undefined : 'manual',
                };
                
                // ç§»é™¤ undefined å€¼
                Object.keys(payload).forEach(key => {
                    if (payload[key] === undefined) {
                        delete payload[key];
                    }
                });
                
                const url = isEdit ? `${API_BASE}/${editId}` : API_BASE;
                const method = isEdit ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await res.json();
                
                if (res.ok && result.success) {
                    closePlaceModal();
                    // åˆ›å»ºæ–°åœ°ç‚¹åå›åˆ°ç¬¬ä¸€é¡µï¼Œç¡®ä¿èƒ½çœ‹åˆ°æ–°åˆ›å»ºçš„
                    if (!isEdit) {
                        currentPage = 1;
                    }
                    await loadPlaces();
                    // æ›´æ–°ç­›é€‰é€‰é¡¹
                    await loadFilterOptions();
                } else {
                    throw new Error(result.message || result.error || 'æ“ä½œå¤±è´¥');
                }
            } catch (e) {
                console.error('ä¿å­˜åœ°ç‚¹å¤±è´¥:', e);
                if (e.message !== 'not_logged_in') {
                    alert(`ä¿å­˜å¤±è´¥: ${e.message}`);
                }
            }
        }

        // ============ åˆé›†æ¨èç›¸å…³åŠŸèƒ½ ============
        
        // åŠ è½½åˆé›†æ¨èåˆ—è¡¨
        async function loadRecommendations() {
            try {
                const listContainer = document.getElementById('recommendationsListContainer');
                if (listContainer) listContainer.style.display = 'block';
                document.getElementById('recommendationsLoading').style.display = 'block';
                document.getElementById('recommendationsLoading').textContent = 'åŠ è½½ä¸­...';
                document.getElementById('recommendationsEmpty').style.display = 'none';
                document.getElementById('recommendationsTable').style.display = 'none';

                const headers = {};
                const token = getStoredToken();
                if (token) headers['Authorization'] = `Bearer ${token}`;
                else {
                    document.getElementById('recommendationsLoading').textContent = 'è¯·å…ˆç™»å½•ç®¡ç†å‘˜åæŸ¥çœ‹åˆé›†æ¨è';
                    return;
                }
                const res = await fetchWithTimeout(`${RECOMMENDATION_API_BASE}`, { headers });
                const result = await res.json();
                if (result.success && Array.isArray(result.data)) {
                    // ç¡®ä¿æŒ‰orderæ’åº
                    recommendations = result.data.sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999;
                        const orderB = b.order !== undefined ? b.order : 999;
                        return orderA - orderB;
                    });
                    renderRecommendations();
                    showRecommendationsList();
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (e) {
                console.error('åŠ è½½åˆé›†æ¨èå¤±è´¥:', e);
                document.getElementById('recommendationsLoading').style.display = 'block';
                document.getElementById('recommendationsLoading').textContent = `åŠ è½½å¤±è´¥: ${e.message || 'è¯·æ£€æŸ¥åç«¯æˆ–æ˜¯å¦å·²è®¾ç½®ç®¡ç†å‘˜ Token'}`;
                document.getElementById('recommendationsEmpty').style.display = 'none';
                document.getElementById('recommendationsTable').style.display = 'none';
            }
        }

        // æ¸²æŸ“åˆé›†æ¨èåˆ—è¡¨ï¼ˆæ”¯æŒæ‹–æ‹½æ’åºï¼‰
        function renderRecommendations() {
            const body = document.getElementById('recommendationsBody');
            body.innerHTML = '';

            if (recommendations.length === 0) {
                document.getElementById('recommendationsLoading').style.display = 'none';
                document.getElementById('recommendationsEmpty').style.display = 'block';
                document.getElementById('recommendationsTable').style.display = 'none';
                return;
            }

            document.getElementById('recommendationsLoading').style.display = 'none';
            document.getElementById('recommendationsEmpty').style.display = 'none';
            document.getElementById('recommendationsTable').style.display = 'table';

            // ç¡®ä¿æŒ‰orderæ’åº
            const sortedRecommendations = [...recommendations].sort((a, b) => {
                const orderA = a.order !== undefined ? a.order : 999;
                const orderB = b.order !== undefined ? b.order : 999;
                return orderA - orderB;
            });

            sortedRecommendations.forEach((rec, index) => {
                const tr = document.createElement('tr');
                tr.className = 'draggable-recommendation';
                tr.setAttribute('draggable', 'true');
                tr.setAttribute('data-id', rec.id);
                tr.setAttribute('data-index', index);
                const count = Array.isArray(rec.items) ? rec.items.length : 0;
                tr.innerHTML = `
                    <td style="cursor: move; user-select: none;">â‹®â‹®</td>
                    <td class="place-name">${rec.name}</td>
                    <td>${count}</td>
                    <td>${rec.createdAt ? new Date(rec.createdAt).toLocaleString() : '-'}</td>
                    <td>${rec.updatedAt ? new Date(rec.updatedAt).toLocaleString() : '-'}</td>
                    <td>
                        <div class="list-actions">
                            <button class="btn btn-secondary" onclick="startEditRecommendation('${rec.id}')">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deleteRecommendation('${rec.id}', '${rec.name.replace(/'/g, "\\'")}')">åˆ é™¤</button>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
            
            // æ›´æ–°recommendationsæ•°ç»„ä¸ºæ’åºåçš„é¡ºåºï¼ˆä¿æŒå¼•ç”¨ï¼Œé¿å…é‡æ–°æ¸²æŸ“ï¼‰
            recommendations.length = 0;
            recommendations.push(...sortedRecommendations);

            // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
            setupRecommendationsDragAndDrop();
        }

        // æ˜¾ç¤ºåˆé›†æ¨èåˆ—è¡¨
        function showRecommendationsList(show = true) {
            const listContainer = document.getElementById('recommendationsListContainer');
            if (listContainer) {
                listContainer.style.display = show ? 'block' : 'none';
            }
            if (show) {
                document.getElementById('recommendationsLoading').style.display = 'none';
                document.getElementById('recommendationsEmpty').style.display = 'none';
                document.getElementById('recommendationsTable').style.display = 'table';
                showRecommendationForm(false);
            }
        }

        // æ˜¾ç¤º/éšè—åˆé›†æ¨èè¡¨å•
        function showRecommendationForm(show) {
            const container = document.getElementById('recommendationFormContainer');
            if (!container) return;
            container.style.display = show ? 'block' : 'none';
        }

        // å¼€å§‹åˆ›å»ºåˆé›†æ¨è
        function startCreateRecommendation() {
            clearRecommendationForm();
            editingRecommendationId = null;
            // åˆå§‹åŒ–åŸå§‹æ•°æ®ä¸ºç©ºï¼ˆåˆ›å»ºæ¨¡å¼ï¼‰
            originalRecommendationData = {
                name: '',
                collectionIds: ''
            };
            document.getElementById('recommendationFormHeader').style.display = 'block';
            document.getElementById('editRecommendationModeTitle').textContent = 'åˆ›å»ºåˆé›†æ¨è';
            document.getElementById('saveRecommendationBtn').textContent = 'ä¿å­˜';
            showRecommendationForm(true);
            showRecommendationsList(false);
            document.querySelector('.nav-tabs').style.display = 'none';
            document.querySelector('.collections-actions').style.display = 'none';
        }

        // å¼€å§‹ç¼–è¾‘åˆé›†æ¨è
        async function startEditRecommendation(id) {
            try {
                const token = getTokenOrAlert();
                if (!token) return;

                const res = await fetchWithTimeout(`${RECOMMENDATION_API_BASE}/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                if (!result.success || !result.data) {
                    throw new Error(result.message || 'è·å–æ¨èè¯¦æƒ…å¤±è´¥');
                }

                const rec = result.data;
                editingRecommendationId = id;
                document.getElementById('recommendationFormHeader').style.display = 'block';
                document.getElementById('editRecommendationModeTitle').textContent = `ç¼–è¾‘åˆé›†æ¨è: ${rec.name}`;
                document.getElementById('saveRecommendationBtn').textContent = 'ä¿å­˜';
                showRecommendationForm(true);
                showRecommendationsList(false);
                document.querySelector('.nav-tabs').style.display = 'none';
                document.querySelector('.collections-actions').style.display = 'none';

                // å¡«å……è¡¨å•
                document.getElementById('recommendationName').value = rec.name || '';
                selectedCollections = (rec.items || []).map(item => ({
                    id: item.collection.id,
                    name: item.collection.name,
                    coverImage: item.collection.coverImage,
                    description: item.collection.description,
                }));
                renderSelectedCollections();
                
                // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºæ£€æµ‹æ˜¯å¦æœ‰ä¿®æ”¹
                originalRecommendationData = {
                    name: rec.name || '',
                    collectionIds: selectedCollections.map(c => c.id).sort().join(',')
                };
            } catch (e) {
                console.error('åŠ è½½æ¨èè¯¦æƒ…å¤±è´¥:', e);
                alert('åŠ è½½æ¨èè¯¦æƒ…å¤±è´¥: ' + e.message);
            }
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEditRecommendation() {
            // æ£€æµ‹æ˜¯å¦æœ‰ä¿®æ”¹
            const hasChanges = checkRecommendationFormChanges();
            if (hasChanges) {
                if (confirm('ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                    backToRecommendationsList();
                }
            } else {
                // æ²¡æœ‰ä¿®æ”¹ï¼Œç›´æ¥è¿”å›
                backToRecommendationsList();
            }
        }
        
        // æ£€æµ‹æ¨èè¡¨å•æ˜¯å¦æœ‰ä¿®æ”¹
        function checkRecommendationFormChanges() {
            if (!originalRecommendationData) return false;
            
            const currentData = {
                name: document.getElementById('recommendationName').value || '',
                collectionIds: selectedCollections.map(c => c.id).sort().join(',')
            };
            
            return currentData.name !== originalRecommendationData.name ||
                   currentData.collectionIds !== originalRecommendationData.collectionIds;
        }

        // è¿”å›åˆé›†æ¨èåˆ—è¡¨
        function backToRecommendationsList() {
            editingRecommendationId = null;
            originalRecommendationData = null; // æ¸…ç©ºåŸå§‹æ•°æ®
            clearRecommendationForm();
            showRecommendationsList(true);
            document.querySelector('.nav-tabs').style.display = 'flex';
            document.querySelector('.collections-actions').style.display = 'flex';
        }

        // æ¸…ç©ºè¡¨å•
        function clearRecommendationForm() {
            document.getElementById('recommendationName').value = '';
            selectedCollections = [];
            renderSelectedCollections();
            document.getElementById('collectionSearchInput').value = '';
            document.getElementById('collectionSearchDropdown').style.display = 'none';
        }

        // ä¿å­˜åˆé›†æ¨è
        async function saveRecommendation() {
            const name = document.getElementById('recommendationName').value.trim();
            if (!name) {
                alert('æ¨èåç§°å¿…å¡«');
                return;
            }
            if (selectedCollections.length === 0) {
                alert('è‡³å°‘éœ€è¦é€‰æ‹©ä¸€ä¸ªåˆé›†');
                return;
            }

            try {
                const token = getTokenOrAlert();
                if (!token) return;

                const collectionIds = selectedCollections.map(c => c.id);
                const isEdit = !!editingRecommendationId;

                let res;
                if (isEdit) {
                    res = await fetchWithTimeout(`${RECOMMENDATION_API_BASE}/${editingRecommendationId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, collectionIds })
                    });
                } else {
                    res = await fetchWithTimeout(`${RECOMMENDATION_API_BASE}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, collectionIds })
                    });
                }

                const result = await res.json();
                if (!result.success) {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }

                // ç›´æ¥åˆ·æ–°æ•°æ®å¹¶è¿”å›åˆ—è¡¨ï¼Œä¸å¼¹çª—
                await loadRecommendations();
                backToRecommendationsList();
            } catch (e) {
                console.error('ä¿å­˜æ¨èå¤±è´¥:', e);
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤åˆé›†æ¨è
        async function deleteRecommendation(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆé›†æ¨è "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const token = getTokenOrAlert();
                if (!token) return;

                const res = await fetchWithTimeout(`${RECOMMENDATION_API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();
                if (!result.success) {
                    throw new Error(result.message || 'åˆ é™¤å¤±è´¥');
                }

                alert('åˆ é™¤æˆåŠŸ');
                await loadRecommendations();
            } catch (e) {
                console.error('åˆ é™¤æ¨èå¤±è´¥:', e);
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // æœç´¢åˆé›†ï¼ˆæ¨¡ç³Šæœç´¢ï¼‰
        function handleCollectionSearch(query) {
            if (collectionSearchTimer) {
                clearTimeout(collectionSearchTimer);
            }

            const dropdown = document.getElementById('collectionSearchDropdown');
            if (!query || query.trim().length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            collectionSearchTimer = setTimeout(async () => {
                try {
                    const token = getStoredToken();
                    if (!token) {
                        dropdown.innerHTML = '<div style="padding:12px;color:#999;">è¯·å…ˆç™»å½•ç®¡ç†å‘˜</div>';
                        dropdown.style.display = 'block';
                        return;
                    }

                    const headers = { 'Authorization': `Bearer ${token}` };
                    const res = await fetchWithTimeout(`${RECOMMENDATION_API_BASE}/search-collections?q=${encodeURIComponent(query)}`, { headers });
                    
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ message: `HTTP ${res.status}` }));
                        throw new Error(errorData.message || `è¯·æ±‚å¤±è´¥: ${res.status}`);
                    }

                    const result = await res.json();
                    console.log('æœç´¢åˆé›†å“åº”:', result);
                    
                    if (result.success && Array.isArray(result.data)) {
                        const collections = result.data;
                        if (collections.length === 0) {
                            dropdown.innerHTML = '<div style="padding:12px;color:#999;">æœªæ‰¾åˆ°åŒ¹é…çš„åˆé›†</div>';
                        } else {
                            dropdown.innerHTML = collections.map(c => `
                                <div class="dropdown-item" onclick="selectCollection('${c.id}', '${c.name.replace(/'/g, "\\'")}', '${(c.coverImage || '').replace(/'/g, "\\'")}', '${(c.description || '').replace(/'/g, "\\'")}')">
                                    <img src="${c.coverImage || ''}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;margin-right:8px;" onerror="this.style.display='none'">
                                    <div>
                                        <div style="font-weight:600;">${c.name}</div>
                                        ${c.description ? `<div style="font-size:12px;color:#999;">${c.description}</div>` : ''}
                                    </div>
                                </div>
                            `).join('');
                        }
                        dropdown.style.display = 'block';
                    } else {
                        const errorMsg = result.message || 'æœç´¢å¤±è´¥';
                        console.error('æœç´¢åˆé›†å¤±è´¥:', result);
                        dropdown.innerHTML = `<div style="padding:12px;color:#dc3545;">${errorMsg}</div>`;
                        dropdown.style.display = 'block';
                    }
                } catch (e) {
                    console.error('æœç´¢åˆé›†å¤±è´¥', e);
                    const errorMsg = e.message || 'æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•';
                    dropdown.innerHTML = `<div style="padding:12px;color:#dc3545;">${errorMsg}</div>`;
                    dropdown.style.display = 'block';
                }
            }, 300);
        }

        // é€‰æ‹©åˆé›†
        function selectCollection(id, name, coverImage, description) {
            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
            if (selectedCollections.some(c => c.id === id)) {
                alert('è¯¥åˆé›†å·²æ·»åŠ ');
                return;
            }

            selectedCollections.push({ id, name, coverImage, description });
            renderSelectedCollections();
            document.getElementById('collectionSearchInput').value = '';
            document.getElementById('collectionSearchDropdown').style.display = 'none';
        }

        // ç§»é™¤é€‰ä¸­çš„åˆé›†
        function removeCollection(index) {
            selectedCollections.splice(index, 1);
            renderSelectedCollections();
        }

        // æ¸²æŸ“é€‰ä¸­çš„åˆé›†åˆ—è¡¨ï¼ˆæ”¯æŒæ‹–æ‹½æ’åºï¼‰
        function renderSelectedCollections() {
            const container = document.getElementById('selectedCollections');
            if (!container) return;

            if (selectedCollections.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">æš‚æ— é€‰ä¸­çš„åˆé›†ï¼Œè¯·åœ¨ä¸Šæ–¹æœç´¢å¹¶æ·»åŠ </div>';
                return;
            }

            container.innerHTML = selectedCollections.map((col, index) => `
                <div class="chip draggable-collection" data-index="${index}" draggable="true">
                    <img src="${col.coverImage || ''}" style="width:32px;height:32px;object-fit:cover;border-radius:4px;margin-right:8px;" onerror="this.style.display='none'">
                    <span>${col.name}</span>
                    <button class="chip-remove" onclick="removeCollection(${index})" title="ç§»é™¤">Ã—</button>
                </div>
            `).join('');

            // æ·»åŠ æ‹–æ‹½äº‹ä»¶
            setupDragAndDrop();
        }

        // è®¾ç½®æ‹–æ‹½æ’åº
        function setupDragAndDrop() {
            const items = document.querySelectorAll('.draggable-collection');
            let draggedElement = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedElement = item;
                    item.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.style.opacity = '1';
                    draggedElement = null;
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    if (draggedElement && draggedElement !== item) {
                        const allItems = Array.from(items);
                        const draggedIndex = allItems.indexOf(draggedElement);
                        const targetIndex = allItems.indexOf(item);
                        if (draggedIndex !== targetIndex) {
                            const container = document.getElementById('selectedCollections');
                            if (draggedIndex < targetIndex) {
                                container.insertBefore(draggedElement, item.nextSibling);
                            } else {
                                container.insertBefore(draggedElement, item);
                            }
                            // æ›´æ–°æ•°ç»„é¡ºåº
                            const [moved] = selectedCollections.splice(draggedIndex, 1);
                            selectedCollections.splice(targetIndex, 0, moved);
                            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç´¢å¼•
                            renderSelectedCollections();
                        }
                    }
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                });
            });
        }

        // è®¾ç½®æ¨èåˆ—è¡¨çš„æ‹–æ‹½æ’åº
        function setupRecommendationsDragAndDrop() {
            const tbody = document.getElementById('recommendationsBody');
            let draggedElement = null;
            let draggedIndex = -1;

            tbody.addEventListener('dragstart', (e) => {
                const row = e.target.closest('.draggable-recommendation');
                if (!row) return;
                draggedElement = row;
                draggedIndex = Array.from(tbody.children).indexOf(row);
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            tbody.addEventListener('dragend', (e) => {
                const row = e.target.closest('.draggable-recommendation');
                if (row) {
                    row.classList.remove('dragging');
                }
                draggedElement = null;
                draggedIndex = -1;
            });

            tbody.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (!draggedElement) return;
                
                const row = e.target.closest('.draggable-recommendation');
                if (!row || row === draggedElement) return;
                
                const rows = Array.from(tbody.children);
                const targetIndex = rows.indexOf(row);
                const currentDraggedIndex = rows.indexOf(draggedElement);
                
                if (currentDraggedIndex === targetIndex) return;
                
                // ç§»åŠ¨ DOM å…ƒç´ 
                if (currentDraggedIndex < targetIndex) {
                    tbody.insertBefore(draggedElement, row.nextSibling);
                } else {
                    tbody.insertBefore(draggedElement, row);
                }
            });

            tbody.addEventListener('drop', (e) => {
                e.preventDefault();
                
                if (!draggedElement) return;
                
                // è·å–æ–°çš„é¡ºåº
                const rows = Array.from(tbody.children);
                const newOrder = rows.map(row => row.getAttribute('data-id'));
                
                console.log('æ‹–æ‹½å®Œæˆï¼Œæ–°é¡ºåº:', newOrder);
                
                // æ›´æ–° recommendations æ•°ç»„é¡ºåº
                const reorderedRecommendations = newOrder.map(id => 
                    recommendations.find(r => r.id === id)
                ).filter(Boolean);
                
                recommendations.length = 0;
                recommendations.push(...reorderedRecommendations);
                
                // ä¿å­˜æ–°é¡ºåºåˆ°æœåŠ¡å™¨
                saveRecommendationsOrderWithIds(newOrder).then(() => {
                    console.log('ä¿å­˜æˆåŠŸ');
                    showToast('é¡ºåºå·²ä¿å­˜', 'success');
                    // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç´¢å¼•æ˜¾ç¤º
                    renderRecommendations();
                }).catch((error) => {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    showToast('ä¿å­˜é¡ºåºå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    // é‡æ–°åŠ è½½ä»¥æ¢å¤åŸå§‹é¡ºåº
                    loadRecommendations();
                });
            });
        }

        // ä¿å­˜æ¨èåˆ—è¡¨é¡ºåºï¼ˆä½¿ç”¨æŒ‡å®šçš„IDåˆ—è¡¨ï¼‰
        async function saveRecommendationsOrderWithIds(recommendationIds) {
            if (!recommendationIds || recommendationIds.length === 0) {
                console.warn('æ²¡æœ‰æ¨èIDéœ€è¦ä¿å­˜');
                return;
            }

            try {
                const token = getTokenOrAlert();
                if (!token) {
                    throw new Error('è¯·å…ˆç™»å½•ç®¡ç†å‘˜');
                }

                console.log('ğŸ“¤ å‘é€ä¿å­˜é¡ºåºè¯·æ±‚ï¼ŒIDs:', recommendationIds);
                console.log('ğŸ“¤ å¯¹åº”çš„åç§°å’ŒæœŸæœ›çš„order:', recommendationIds.map((id, idx) => {
                    const rec = recommendations.find(r => r.id === id);
                    return { id, name: rec?.name || 'æœªçŸ¥', expectedOrder: idx };
                }));

                const res = await fetchWithTimeout(`${RECOMMENDATION_API_BASE}/order`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ recommendationIds })
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ message: `HTTP ${res.status}` }));
                    throw new Error(errorData.message || `è¯·æ±‚å¤±è´¥: ${res.status}`);
                }

                const result = await res.json();
                if (!result.success) {
                    throw new Error(result.message || 'æ›´æ–°é¡ºåºå¤±è´¥');
                }

                // æ›´æ–°æœ¬åœ°æ•°æ®ï¼Œç¡®ä¿æŒ‰orderæ’åº
                if (result.data && Array.isArray(result.data)) {
                    recommendations = result.data.sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999;
                        const orderB = b.order !== undefined ? b.order : 999;
                        return orderA - orderB;
                    });
                    console.log('âœ… æ¨èé¡ºåºå·²ä¿å­˜ï¼');
                    console.log('ğŸ“‹ æœåŠ¡å™¨è¿”å›çš„é¡ºåº:', recommendations.map(r => ({ name: r.name, order: r.order, id: r.id })));
                } else {
                    console.warn('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®:', result);
                }
            } catch (e) {
                console.error('ä¿å­˜æ¨èé¡ºåºå¤±è´¥:', e);
                console.error('å°è¯•ä¿å­˜çš„IDåˆ—è¡¨:', recommendationIds);
                console.error('å½“å‰æ¨èåˆ—è¡¨:', recommendations.map(r => ({ id: r.id, name: r.name })));
                throw e; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
            }
        }

        // ä¿å­˜æ¨èåˆ—è¡¨é¡ºåºï¼ˆä½¿ç”¨å½“å‰recommendationsæ•°ç»„ï¼‰
        async function saveRecommendationsOrder() {
            const recommendationIds = recommendations.map(r => r.id);
            return saveRecommendationsOrderWithIds(recommendationIds);
        }
    </script>
</body>
</html>
