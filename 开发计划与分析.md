# Wanderlog 开发计划与技术分析

## 一、项目概述

Wanderlog 是一个智能旅行规划应用，帮助用户规划、管理和分享旅行行程。核心功能包括景点推荐、行程定制、地图可视化、Google Maps 标记点导入等。

## 二、需求分析

### 2.1 核心功能模块

#### 1. 首页（Homepage）
- **推荐景点**：按城市推荐 spots
- **行程定制**：选择城市、时间、标签、spots
- **地图模式**：环球地图视图，支持标签筛选、地点卡片展示，点击跳转 Google Maps
- **Google Maps 导入**：导入用户已有的标记点，同步到云端，支持共享

#### 2. 我的行程（MyTrip）
- **Spots 管理**：
  - **Wishlist**：愿望清单
  - **Visited**：已访问（标记日期、记录感受、上传图片、评分，地图置灰显示）
  - **Today's Plan**：今日计划（关注营业时间、地图位置、顺序、购票信息）
- **优先级管理**：必去、可去可不去
- **时区检查**：本地时区支持

#### 3. 基础能力（Foundation）
- **AI 识别**：拍照识别，集成 ChatGPT 或 Gemini
- **支付系统**：Stripe 集成
  - 付费场景：
    1. 仅支持 1 个城市免费，多个城市需付费（可查看，不能收藏或导入）
    2. 评论免费，上传图片付费
    3. 分享模板定制化付费
    4. 地图皮肤更换付费

### 2.2 技术要求

- **平台**：iOS APP + Android APP + Web APP（统一使用 Flutter）
- **认证**：Gmail 和其他邮箱登录、验证
- **地图服务**：Mapbox 地图集成
- **Google 集成**：调用 Google API 导入用户标记点
- **AI 服务**：ChatGPT 或 Gemini 集成

## 三、技术架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                  前端层 (Frontend - Flutter)              │
│  ┌──────────────┬──────────────┬──────────────────────┐ │
│  │  iOS App     │  Android App │    Web App           │ │
│  │  (Flutter)   │  (Flutter)   │    (Flutter Web)     │ │
│  └──────────────┴──────────────┴──────────────────────┘ │
│           一套代码，多端运行 (Write Once, Run Anywhere)   │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                    API 网关层 (Gateway)                   │
│              (统一认证、路由、限流、日志)                    │
└─────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                   后端服务层 (Backend)                     │
├──────────────┬──────────────┬──────────────┬────────────┤
│  用户服务    │  行程服务    │  地图服务    │  支付服务   │
│  Auth API    │  Trip API    │  Map API     │  Payment   │
└──────────────┴──────────────┴──────────────┴────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                   数据层 (Data Layer)                     │
├──────────────┬──────────────┬──────────────┬────────────┤
│  PostgreSQL  │   Redis      │   S3/OSS     │  Elastic   │
│  (主数据库)   │  (缓存)      │  (文件存储)   │  (搜索)     │
└──────────────┴──────────────┴──────────────┴────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────┐
│                   第三方服务集成                           │
├──────────────┬──────────────┬──────────────┬────────────┤
│  Google API  │   Mapbox     │   OpenAI/    │  Stripe    │
│  (Maps/      │   (地图)     │   Gemini     │  (支付)    │
│   OAuth)     │              │   (AI)       │            │
└──────────────┴──────────────┴──────────────┴────────────┘
```

### 3.2 技术栈选型

#### 前端技术栈（统一使用 Flutter）

**Flutter 跨平台方案：**
- **框架**：Flutter 3.24+ (Dart 3.4+)
- **优势**：
  - ✅ **一套代码，多端运行**：iOS、Android、Web 共享代码库
  - ✅ **开发效率高**：减少 50-70% 的重复开发工作
  - ✅ **UI 一致性**：保证各平台用户体验一致
  - ✅ **性能优秀**：接近原生性能（60fps）
  - ✅ **热重载**：快速迭代开发
  - ✅ **丰富的生态**：大量成熟的插件和包

**核心依赖包：**
- **状态管理**：Riverpod / Provider / Bloc
- **网络请求**：Dio / http
- **本地存储**：Hive / SharedPreferences / sqflite
- **路由导航**：go_router / auto_route
- **地图服务**：mapbox_maps_flutter / flutter_map
- **认证**：google_sign_in / firebase_auth
- **支付**：flutter_stripe / in_app_purchase
- **图片处理**：image_picker / cached_network_image
- **HTTP 客户端**：Dio (支持拦截器、缓存)
- **JSON 序列化**：json_serializable / freezed
- **国际化**：flutter_localizations / intl
- **UI 组件库**：Material Design 3 / Cupertino

**平台特定配置：**
- **iOS**：iOS 12.0+，支持 Swift/Objective-C 桥接
- **Android**：Android 5.0+ (API 21+)，支持 Kotlin/Java 桥接
- **Web**：支持 Chrome、Safari、Firefox、Edge（现代浏览器）

**Web 平台优化：**
- 使用 `flutter build web --web-renderer canvaskit` 或 `html` 渲染器
- 配置 PWA 支持（可选）
- SEO 优化（使用 SSR 或静态站点生成，可选）

#### 后端技术栈

**推荐方案：**
- **语言**：Node.js (TypeScript) 或 Python (FastAPI)
- **框架**：Express.js / FastAPI
- **数据库**：PostgreSQL 15+
- **ORM**：Prisma / SQLAlchemy
- **缓存**：Redis
- **文件存储**：AWS S3 / 阿里云 OSS
- **搜索**：Elasticsearch / Algolia
- **消息队列**：RabbitMQ / AWS SQS
- **API 文档**：Swagger / OpenAPI

**备选方案：**
- **语言**：Go (Gin/Echo)
- **优势**：高性能、并发能力强

#### 第三方服务集成

- **Google APIs**：
  - Google OAuth 2.0 (登录认证)
  - Google Maps Platform API (导入标记点)
  - Google Places API (地点搜索)
- **Mapbox**：
  - mapbox_maps_flutter (Flutter 统一 SDK，支持 iOS/Android/Web)
  - 或使用 flutter_map + Mapbox 瓦片服务
- **AI 服务**：
  - OpenAI API (ChatGPT)
  - Google Gemini API
- **支付**：
  - Stripe API

## 四、详细开发步骤

### Phase 1: 项目基础搭建（2-3 周）

#### 1.1 项目初始化
- [ ] 创建 Git 仓库，设置分支策略（main, develop, feature/*）
- [ ] 搭建后端项目结构
  - [ ] 初始化 Node.js/Python 项目
  - [ ] 配置 TypeScript/类型检查
  - [ ] 设置 ESLint/Prettier
  - [ ] 配置环境变量管理（.env）
- [ ] 搭建 Flutter 跨平台项目
  - [ ] 创建 Flutter 项目（`flutter create wanderlog`）
  - [ ] 配置项目结构（lib/ 目录组织）
    - [ ] `lib/core/`：核心功能（网络、存储、工具类）
    - [ ] `lib/features/`：功能模块（auth, trips, maps, etc.）
    - [ ] `lib/shared/`：共享组件和工具
    - [ ] `lib/models/`：数据模型
    - [ ] `lib/services/`：服务层（API、本地存储）
    - [ ] `lib/widgets/`：通用 Widget
  - [ ] 配置 pubspec.yaml（依赖管理）
  - [ ] 设置代码规范（dart format, analysis_options.yaml）
  - [ ] 配置多环境（dev, staging, production）

#### 1.2 开发环境配置
- [ ] 配置数据库（PostgreSQL）
  - [ ] 创建开发/测试/生产环境数据库
  - [ ] 设置数据库迁移工具
- [ ] 配置 Redis（缓存）
- [ ] 配置文件存储服务（S3/OSS）
- [ ] 设置 CI/CD 流程（GitHub Actions / GitLab CI）

#### 1.3 第三方服务账号申请
- [ ] 注册 Google Cloud Platform 账号
  - [ ] 创建 OAuth 2.0 客户端 ID（Web + iOS + Android）
  - [ ] 启用 Google Maps Platform API
  - [ ] 启用 Google Places API
  - [ ] 获取 API Keys
- [ ] 注册 Mapbox 账号
  - [ ] 创建 Access Token
  - [ ] 配置地图样式
- [ ] 注册 Stripe 账号
  - [ ] 创建测试/生产环境密钥
- [ ] 注册 OpenAI / Google Gemini 账号
  - [ ] 获取 API Keys

### Phase 2: 用户认证系统（2-3 周）

#### 2.1 后端认证服务
- [ ] 设计用户数据模型
  - [ ] User 表（id, email, name, avatar, provider, provider_id）
  - [ ] Session 表（token, user_id, expires_at）
- [ ] 实现 OAuth 2.0 认证流程
  - [ ] Google OAuth 集成
  - [ ] 邮箱密码登录（可选）
  - [ ] JWT Token 生成与验证
  - [ ] Refresh Token 机制
- [ ] 实现邮箱验证
  - [ ] 发送验证邮件（SendGrid / AWS SES）
  - [ ] 验证链接生成与验证
- [ ] 实现用户注册/登录 API
  - [ ] POST /api/auth/google
  - [ ] POST /api/auth/email/login
  - [ ] POST /api/auth/email/register
  - [ ] POST /api/auth/verify-email
  - [ ] POST /api/auth/refresh
  - [ ] POST /api/auth/logout
  - [ ] GET /api/auth/me

#### 2.2 Flutter 前端认证（统一实现）
- [ ] 集成认证相关包
  - [ ] `google_sign_in`：Google 登录
  - [ ] `firebase_auth` 或自定义邮箱认证
  - [ ] `shared_preferences` / `flutter_secure_storage`：Token 存储
- [ ] 实现认证服务层
  - [ ] `AuthService`：统一认证逻辑
  - [ ] Google OAuth 流程实现
  - [ ] 邮箱登录/注册流程
  - [ ] Token 管理与刷新
- [ ] 实现认证 UI（一套代码，多端运行）
  - [ ] 登录页面（LoginScreen）
  - [ ] 注册页面（RegisterScreen）
  - [ ] 邮箱验证页面（VerifyEmailScreen）
  - [ ] 使用 Material Design 3 / Cupertino 风格
- [ ] 实现认证状态管理
  - [ ] 使用 Riverpod / Provider 管理认证状态
  - [ ] 路由守卫（未登录跳转登录页）
  - [ ] 用户信息缓存
- [ ] 平台特定配置
  - [ ] iOS：配置 GoogleService-Info.plist
  - [ ] Android：配置 google-services.json
  - [ ] Web：配置 OAuth 重定向 URL

### Phase 3: 核心数据模型设计（1-2 周）

#### 3.1 数据库设计
- [ ] 设计数据表结构
  - [ ] **Users**：用户表
  - [ ] **Trips**：行程表（id, user_id, city, start_date, end_date, status）
  - [ ] **Spots**：地点表（id, name, address, lat, lng, city, category, rating）
  - [ ] **Trip_Spots**：行程-地点关联表（trip_id, spot_id, status, priority, order, visit_date）
  - [ ] **Spot_Status**：地点状态枚举（Wishlist, Visited, Today's Plan）
  - [ ] **Spot_Reviews**：地点评价表（spot_id, user_id, rating, comment, images, visit_date）
  - [ ] **Spot_Images**：地点图片表（spot_id, image_url, upload_date）
  - [ ] **Google_Maps_Sync**：Google Maps 同步表（user_id, sync_token, last_sync_at）
  - [ ] **Labels**：标签表（id, name, color）
  - [ ] **Spot_Labels**：地点-标签关联表
- [ ] 创建数据库迁移脚本
- [ ] 设计索引策略（性能优化）

#### 3.2 API 数据模型定义
- [ ] 定义 TypeScript/Python 数据模型
- [ ] 实现数据验证（Zod / Pydantic）
- [ ] 编写 API 文档（Swagger）

### Phase 4: Google Maps 标记点导入（2-3 周）

#### 4.1 Google Maps API 集成
- [ ] 研究 Google Maps Platform API
  - [ ] 了解 Saved Places API
  - [ ] 了解 My Maps API（如果适用）
  - [ ] 了解 Places API
- [ ] 实现 Google Maps 数据获取
  - [ ] OAuth 2.0 授权流程（获取用户 Google Maps 权限）
  - [ ] 调用 Google Maps API 获取用户标记点
  - [ ] 数据解析与转换
- [ ] 实现数据同步服务
  - [ ] 后台任务同步标记点
  - [ ] 增量同步机制
  - [ ] 错误处理与重试

#### 4.2 后端 API 开发
- [ ] POST /api/google-maps/authorize：授权 Google Maps
- [ ] POST /api/google-maps/sync：同步标记点
- [ ] GET /api/google-maps/sync-status：查询同步状态
- [ ] POST /api/google-maps/import：导入标记点到行程

#### 4.3 Flutter 前端集成（统一实现）
- [ ] 实现 Google Maps 授权与导入功能
  - [ ] 授权页面（GoogleOAuthScreen）
  - [ ] 导入进度显示
  - [ ] 标记点预览与选择
  - [ ] 同步状态管理
- [ ] 平台适配
  - [ ] iOS：使用 `google_sign_in` 获取权限
  - [ ] Android：使用 `google_sign_in` 获取权限
  - [ ] Web：使用 OAuth 2.0 流程

### Phase 5: Mapbox 地图集成（2-3 周）

#### 5.1 Flutter 地图集成（统一实现）
- [ ] 选择地图方案
  - [ ] **方案一**：`mapbox_maps_flutter`（官方 Flutter SDK，推荐）
  - [ ] **方案二**：`flutter_map` + Mapbox 瓦片服务（轻量级）
- [ ] 集成地图 SDK
  - [ ] 配置 Mapbox Access Token
  - [ ] 初始化地图 Widget（MapWidget）
  - [ ] 实现地图样式切换
- [ ] 实现地图功能（一套代码，多端运行）
  - [ ] 标记点展示（Markers）
  - [ ] 标签筛选（Filter）
  - [ ] 地点卡片（InfoWindow / Popup）
  - [ ] 点击跳转 Google Maps（使用 `url_launcher`）
  - [ ] 地图搜索
  - [ ] 路线规划（可选，使用 Mapbox Directions API）
  - [ ] 地图手势控制（缩放、平移、旋转）
- [ ] 平台特定优化
  - [ ] iOS：性能优化，原生地图桥接（如需要）
  - [ ] Android：性能优化，原生地图桥接（如需要）
  - [ ] Web：使用 HTML 渲染器优化性能

#### 5.2 地图数据服务
- [ ] 实现地图数据 API
  - [ ] GET /api/map/spots：获取地图标记点
  - [ ] GET /api/map/spots/:id：获取地点详情
  - [ ] POST /api/map/filter：标签筛选

### Phase 6: 行程管理功能（3-4 周）

#### 6.1 行程创建与管理
- [ ] 实现行程 CRUD API
  - [ ] POST /api/trips：创建行程
  - [ ] GET /api/trips：获取用户行程列表
  - [ ] GET /api/trips/:id：获取行程详情
  - [ ] PUT /api/trips/:id：更新行程
  - [ ] DELETE /api/trips/:id：删除行程
- [ ] 实现 Spots 管理 API
  - [ ] POST /api/trips/:id/spots：添加地点到行程
  - [ ] PUT /api/trips/:id/spots/:spot_id：更新地点状态/优先级
  - [ ] DELETE /api/trips/:id/spots/:spot_id：从行程移除地点
  - [ ] PUT /api/trips/:id/spots/order：调整地点顺序

#### 6.2 Spots 状态管理
- [ ] 实现 Wishlist 功能
- [ ] 实现 Visited 功能
  - [ ] 标记访问日期
  - [ ] 记录感受（评论）
  - [ ] 上传图片
  - [ ] 评分
  - [ ] 地图置灰显示
- [ ] 实现 Today's Plan 功能
  - [ ] 营业时间显示
  - [ ] 地图位置展示
  - [ ] 顺序管理
  - [ ] 购票信息（后续）

#### 6.3 Flutter 前端实现（统一实现）
- [ ] 实现行程管理页面（一套代码，多端运行）
  - [ ] 行程列表页（TripListScreen）
  - [ ] 行程详情页（TripDetailScreen）
  - [ ] Spots 管理界面（SpotManagementScreen）
  - [ ] 使用响应式布局适配不同屏幕尺寸

### Phase 7: 首页功能（2-3 周）

#### 7.1 景点推荐
- [ ] 实现推荐算法
  - [ ] 按城市推荐 Spots
  - [ ] 基于用户偏好推荐（可选）
- [ ] 实现推荐 API
  - [ ] GET /api/spots/recommendations：获取推荐景点

#### 7.2 行程定制
- [ ] 实现行程定制流程
  - [ ] 城市选择
  - [ ] 时间选择
  - [ ] 标签选择
  - [ ] Spots 选择
- [ ] 实现定制 API
  - [ ] POST /api/trips/customize：创建定制行程

#### 7.3 地图模式
- [ ] 实现环球地图视图
- [ ] 实现标签筛选
- [ ] 实现地点卡片展示
- [ ] 实现跳转 Google Maps

#### 7.4 Flutter 前端实现（统一实现）
- [ ] 实现首页 UI（HomeScreen）
  - [ ] 推荐景点列表
  - [ ] 行程定制流程
  - [ ] 地图模式切换
  - [ ] 响应式设计适配不同设备

### Phase 8: AI 功能集成（2-3 周）

#### 8.1 AI 服务集成
- [ ] 选择 AI 服务（OpenAI / Gemini）
- [ ] 实现图片识别 API
  - [ ] 图片上传与存储
  - [ ] 调用 AI API 识别图片
  - [ ] 返回识别结果
- [ ] 实现 AI 对话 API（可选）
  - [ ] 行程建议
  - [ ] 景点推荐

#### 8.2 后端 API
- [ ] POST /api/ai/recognize-image：图片识别
- [ ] POST /api/ai/chat：AI 对话

#### 8.3 Flutter 前端实现（统一实现）
- [ ] 实现拍照识别功能
  - [ ] 使用 `image_picker` 选择/拍摄图片
  - [ ] 图片预览与编辑
  - [ ] 调用 AI API 识别
  - [ ] 显示识别结果
- [ ] 平台特定功能
  - [ ] iOS：使用原生相机（AVFoundation 桥接）
  - [ ] Android：使用原生相机（CameraX 桥接）
  - [ ] Web：使用浏览器相机 API

### Phase 9: 支付系统集成（2-3 周）

#### 9.1 Stripe 集成
- [ ] 配置 Stripe 账号
- [ ] 实现支付流程
  - [ ] 创建支付意图（Payment Intent）
  - [ ] 处理支付回调
  - [ ] 订阅管理（如果使用订阅模式）
- [ ] 实现付费功能限制
  - [ ] 城市数量限制
  - [ ] 图片上传限制
  - [ ] 分享模板限制
  - [ ] 地图皮肤限制

#### 9.2 后端 API
- [ ] POST /api/payment/create-intent：创建支付
- [ ] POST /api/payment/webhook：Stripe Webhook
- [ ] GET /api/payment/subscription：获取订阅状态

#### 9.3 Flutter 前端实现（统一实现）
- [ ] 集成 Stripe 支付
  - [ ] 使用 `flutter_stripe` 包
  - [ ] 实现支付页面（PaymentScreen）
  - [ ] 处理支付结果回调
- [ ] 平台特定配置
  - [ ] iOS：配置 Stripe iOS SDK
  - [ ] Android：配置 Stripe Android SDK
  - [ ] Web：使用 Stripe Elements

### Phase 10: 时区与本地化（1-2 周）

#### 10.1 时区处理
- [ ] 实现时区检测
- [ ] 实现时区转换
- [ ] 更新相关 API 支持时区

#### 10.2 本地化
- [ ] 实现多语言支持（i18n）
  - [ ] 使用 `flutter_localizations` 和 `intl` 包
  - [ ] 创建多语言资源文件（ARB 格式）
  - [ ] 支持语言：中文、英文（可扩展）
  - [ ] 实现语言切换功能
- [ ] 时区处理
  - [ ] 使用 `timezone` 包处理时区转换
  - [ ] 显示本地时间

### Phase 11: 测试与优化（2-3 周）

#### 11.1 单元测试
- [ ] 后端 API 单元测试
- [ ] Flutter 单元测试
  - [ ] Widget 测试
  - [ ] 功能测试
  - [ ] 集成测试（使用 `integration_test`）
  - [ ] 测试覆盖率 > 70%

#### 11.2 集成测试
- [ ] API 集成测试
- [ ] 第三方服务集成测试

#### 11.3 性能优化
- [ ] 数据库查询优化
- [ ] API 响应时间优化
- [ ] 前端性能优化（代码分割、懒加载）
- [ ] 图片优化（压缩、CDN）

#### 11.4 安全加固
- [ ] API 安全（Rate Limiting、CORS）
- [ ] 数据加密
- [ ] SQL 注入防护
- [ ] XSS 防护

### Phase 12: 部署与上线（1-2 周）

#### 12.1 后端部署
- [ ] 配置生产环境
- [ ] 部署到云服务器（AWS / 阿里云）
- [ ] 配置域名与 SSL
- [ ] 配置监控与日志

#### 12.2 Flutter 应用发布
- [ ] **Web 部署**
  - [ ] 构建 Web 版本（`flutter build web`）
  - [ ] 部署到 Firebase Hosting / Vercel / Netlify
  - [ ] 配置域名与 CDN
  - [ ] PWA 配置（可选）
- [ ] **iOS 发布**
  - [ ] 配置 App Store Connect
  - [ ] 构建 iOS 版本（`flutter build ios`）
  - [ ] 提交 App Store 审核
  - [ ] TestFlight 测试
- [ ] **Android 发布**
  - [ ] 配置 Google Play Console
  - [ ] 构建 Android 版本（`flutter build appbundle`）
  - [ ] 提交 Google Play 审核
  - [ ] 内部测试版本发布

## 五、关键技术实现要点

### 5.1 Google Maps 标记点导入

**技术难点：**
- Google Maps 没有直接的公开 API 获取用户保存的地点
- 需要使用 Google Places API 或 Google Maps Platform API

**解决方案：**
1. **方案一：Google Places API (Saved Places)**
   - 使用 Google Places API 的 `places.saved` 端点
   - 需要用户授权 Google Places API 权限
   - 可以获取用户保存的地点列表

2. **方案二：Google My Maps API**
   - 如果用户使用 Google My Maps 创建了自定义地图
   - 可以通过 Google My Maps API 获取标记点

3. **方案三：Google Takeout 数据导入**
   - 用户导出 Google Maps 数据（KML/KMZ）
   - 应用解析并导入

**推荐实现：**
```typescript
// 后端示例代码结构
async function syncGoogleMapsPlaces(userId: string, accessToken: string) {
  // 1. 调用 Google Places API 获取用户保存的地点
  // 2. 解析数据并转换为应用数据格式
  // 3. 保存到数据库
  // 4. 返回同步结果
}
```

### 5.2 Mapbox 地图集成（Flutter 统一实现）

**Flutter 实现要点：**
```dart
// 使用 mapbox_maps_flutter
import 'package:mapbox_maps_flutter/mapbox_maps_flutter.dart';

class MapWidget extends StatefulWidget {
  @override
  _MapWidgetState createState() => _MapWidgetState();
}

class _MapWidgetState extends State<MapWidget> {
  late MapboxMap mapboxMap;
  
  @override
  Widget build(BuildContext context) {
    return MapWidget(
      key: ValueKey("mapWidget"),
      cameraOptions: CameraOptions(
        center: Point(coordinates: Position(lng, lat)),
        zoom: 10.0,
      ),
      styleUri: MapboxStyles.MAPBOX_STREETS,
      onMapCreated: (MapboxMap map) {
        mapboxMap = map;
        // 添加标记点
        _addMarker(lat, lng);
      },
    );
  }
  
  void _addMarker(double lat, double lng) {
    // 添加标记点的实现
  }
}
```

**或使用 flutter_map（轻量级方案）：**
```dart
// 使用 flutter_map + Mapbox 瓦片
import 'package:flutter_map/flutter_map.dart';

FlutterMap(
  options: MapOptions(
    center: LatLng(lat, lng),
    zoom: 10.0,
  ),
  children: [
    TileLayer(
      urlTemplate: 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}',
      additionalOptions: {
        'accessToken': 'YOUR_MAPBOX_TOKEN',
        'id': 'mapbox/streets-v11',
      },
    ),
    MarkerLayer(
      markers: [
        Marker(
          point: LatLng(lat, lng),
          builder: (context) => Icon(Icons.location_on),
        ),
      ],
    ),
  ],
)
```

### 5.3 认证流程

**OAuth 2.0 流程：**
1. 用户点击"使用 Google 登录"
2. 重定向到 Google 授权页面
3. 用户授权后，Google 返回授权码
4. 后端用授权码换取 Access Token
5. 使用 Access Token 获取用户信息
6. 创建/更新用户记录
7. 生成 JWT Token 返回客户端

### 5.4 数据同步策略

**Google Maps 同步：**
- 首次同步：全量导入
- 后续同步：增量同步（基于 last_sync_at）
- 后台任务：定时同步（每天一次）
- 手动同步：用户触发

## 六、开发时间估算

| Phase | 任务 | 预估时间 | 人员配置 |
|-------|------|----------|----------|
| Phase 1 | 项目基础搭建 | 2-3 周 | 全栈 1-2 人 |
| Phase 2 | 用户认证系统 | 2-3 周 | 后端 1 人 + 前端 1 人 |
| Phase 3 | 数据模型设计 | 1-2 周 | 后端 1 人 |
| Phase 4 | Google Maps 导入 | 2-3 周 | 后端 1 人 + 前端 1 人 |
| Phase 5 | Mapbox 地图集成 | 2-3 周 | Flutter 开发 1-2 人 |
| Phase 6 | 行程管理功能 | 3-4 周 | 全栈 2 人 |
| Phase 7 | 首页功能 | 2-3 周 | Flutter 开发 1-2 人 |
| Phase 8 | AI 功能集成 | 2-3 周 | 后端 1 人 + Flutter 1 人 |
| Phase 9 | 支付系统集成 | 2-3 周 | 后端 1 人 + Flutter 1 人 |
| Phase 10 | 时区与本地化 | 1-2 周 | Flutter 开发 1 人 |
| Phase 11 | 测试与优化 | 2-3 周 | 全栈团队 |
| Phase 12 | 部署与上线 | 1-2 周 | DevOps 1 人 |
| **总计** | | **20-30 周** | **2-4 人团队** |

**使用 Flutter 的优势：**
- ✅ **开发时间减少 30-40%**：一套代码多端运行，无需重复开发
- ✅ **团队规模更小**：不需要分别的 iOS 和 Web 开发人员
- ✅ **维护成本更低**：bug 修复和功能更新只需一次
- ✅ **UI 一致性更好**：保证各平台用户体验统一

## 七、风险与挑战

### 7.1 技术风险
- **Google Maps API 限制**：API 调用次数限制，需要合理设计缓存策略
- **Mapbox 成本**：地图加载次数计费，需要优化地图使用
- **数据同步**：Google Maps 数据同步可能不稳定，需要完善的错误处理
- **Flutter Web 性能**：Web 端性能可能不如原生 Web 框架，需要优化
- **平台特定功能**：某些平台特定功能可能需要平台通道（Platform Channel）实现
- **包大小**：Flutter 应用包体积可能较大，需要优化

### 7.2 业务风险
- **用户隐私**：Google Maps 数据导入涉及用户隐私，需要明确授权
- **付费转化**：付费功能设计需要平衡用户体验和商业目标
- **数据安全**：用户行程数据安全保护

### 7.3 应对策略
- 提前申请并测试第三方 API
- 设计完善的错误处理和重试机制
- 实现数据备份和恢复机制
- 制定详细的安全策略和隐私政策

## 八、Flutter 技术栈优势总结

### 8.1 为什么选择 Flutter？

1. **开发效率**
   - 一套代码库，同时支持 iOS、Android、Web
   - 热重载功能，快速迭代开发
   - 丰富的插件生态，减少重复造轮子

2. **性能优势**
   - 编译为原生代码（AOT），性能接近原生
   - 60fps 流畅动画
   - 高效的渲染引擎（Skia）

3. **UI 一致性**
   - Material Design 和 Cupertino 风格统一
   - 响应式设计，适配不同屏幕尺寸
   - 自定义 UI 组件，品牌一致性

4. **成本效益**
   - 减少开发人员需求（不需要分别的 iOS/Android/Web 开发）
   - 降低维护成本（bug 修复只需一次）
   - 加快产品上线速度

5. **技术成熟度**
   - Google 官方支持，持续更新
   - 大型公司采用（阿里巴巴、腾讯、字节跳动等）
   - 活跃的社区和丰富的学习资源

### 8.2 Flutter 项目结构建议

```
wanderlog/
├── lib/
│   ├── core/                    # 核心功能
│   │   ├── network/            # 网络层
│   │   ├── storage/            # 存储层
│   │   ├── utils/              # 工具类
│   │   └── constants/          # 常量
│   ├── features/               # 功能模块
│   │   ├── auth/               # 认证模块
│   │   ├── trips/              # 行程模块
│   │   ├── maps/               # 地图模块
│   │   ├── spots/              # 地点模块
│   │   └── payment/            # 支付模块
│   ├── shared/                 # 共享组件
│   │   ├── widgets/           # 通用 Widget
│   │   └── models/            # 数据模型
│   └── main.dart              # 入口文件
├── test/                       # 测试文件
├── android/                    # Android 配置
├── ios/                        # iOS 配置
├── web/                        # Web 配置
└── pubspec.yaml               # 依赖管理
```

### 8.3 关键 Flutter 包推荐

| 功能 | 推荐包 | 说明 |
|------|--------|------|
| 状态管理 | `riverpod` / `provider` | 推荐 Riverpod，类型安全 |
| 网络请求 | `dio` | 功能强大，支持拦截器 |
| 路由导航 | `go_router` | 声明式路由，支持深度链接 |
| 本地存储 | `hive` / `shared_preferences` | Hive 性能更好 |
| 地图 | `mapbox_maps_flutter` | 官方 SDK |
| 认证 | `google_sign_in` | Google 登录 |
| 支付 | `flutter_stripe` | Stripe 支付 |
| 图片 | `cached_network_image` | 网络图片缓存 |
| 国际化 | `flutter_localizations` + `intl` | 官方国际化方案 |

## 九、后续优化方向

1. **社交功能**：行程分享、好友关注
2. **推荐算法**：基于机器学习的个性化推荐
3. **离线地图**：支持离线地图下载
4. **协作功能**：多人协作规划行程
5. **数据分析**：用户行为分析、行程统计
6. **Android 支持**：利用 Flutter 优势，快速上线 Android 版本

---

**文档版本**：v2.0  
**创建日期**：2024  
**最后更新**：2024  
**更新说明**：采用 Flutter 统一技术栈，支持 iOS、Android、Web 三端

